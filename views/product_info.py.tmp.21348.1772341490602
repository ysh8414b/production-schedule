import streamlit as st
import pandas as pd
from io import BytesIO
from views.sales import load_product_rawmeats, sync_product_rawmeats
from supabase import create_client

# ========================
# Supabase ì—°ê²°
# ========================

@st.cache_resource
def get_supabase_client():
    url = st.secrets["SUPABASE_URL"]
    key = st.secrets["SUPABASE_KEY"]
    return create_client(url, key)

supabase = get_supabase_client()

# ========================
# uploaded_products DB í•¨ìˆ˜
# ========================

@st.cache_data(ttl=120)
def load_uploaded_products():
    """uploaded_products í…Œì´ë¸”ì—ì„œ ì œí’ˆ ë¡œë“œ (ìºì‹œ 2ë¶„)"""
    try:
        result = supabase.table("uploaded_products").select("*").order("product_name").execute()
        if result.data:
            return pd.DataFrame(result.data)
    except:
        pass
    return pd.DataFrame(columns=[
        "id", "product_code", "product_name", "origin", "kg_per_box",
        "production_time_per_unit", "production_point", "minimum_production_quantity",
        "current_stock"
    ])


def upsert_uploaded_products_bulk(rows):
    """ì œí’ˆ ì¼ê´„ ë“±ë¡/ìˆ˜ì • (product_code ê¸°ì¤€ upsert)"""
    chunk_size = 500
    for i in range(0, len(rows), chunk_size):
        chunk = rows[i:i + chunk_size]
        supabase.table("uploaded_products").upsert(
            chunk, on_conflict="product_code"
        ).execute()
    load_uploaded_products.clear()
    _clear_schedule_caches()


def delete_uploaded_product(product_id):
    """ì œí’ˆ ì‚­ì œ"""
    supabase.table("uploaded_products").delete().eq("id", product_id).execute()
    load_uploaded_products.clear()
    _clear_schedule_caches()


def update_uploaded_product_stocks_bulk(updates):
    """ì—¬ëŸ¬ ì œí’ˆ ì¬ê³  ì¼ê´„ ì—…ë°ì´íŠ¸. updates: list of dict with product_code, current_stock"""
    if not updates:
        return
    for item in updates:
        supabase.table("uploaded_products").update(
            {"current_stock": int(item["current_stock"])}
        ).eq("product_code", item["product_code"]).execute()
    load_uploaded_products.clear()
    _clear_schedule_caches()


def _clear_schedule_caches():
    """ìŠ¤ì¼€ì¤„ í˜ì´ì§€ ìºì‹œ í´ë¦¬ì–´"""
    try:
        from views.schedule import load_inventory_from_db, load_all_product_names
        load_inventory_from_db.clear()
        load_all_product_names.clear()
    except Exception:
        pass


# ========================
# í˜ì´ì§€ ë Œë”ë§
# ========================

st.title("ğŸ“¦ ì œí’ˆ")

tab1, tab2 = st.tabs(["ğŸ“¤ ì œí’ˆ ì—…ë¡œë“œ", "ğŸ“¦ ì œí’ˆ-ì›ìœ¡ ë§¤í•‘"])

# ========================
# Tab 1: ì œí’ˆ ì—…ë¡œë“œ
# ========================

with tab1:
    menu = st.radio("ì„ íƒ", [
        "ğŸ“‹ ì œí’ˆ ëª©ë¡",
        "ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ",
        "ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ",
        "ğŸ“¦ ì¬ê³  ê´€ë¦¬"
    ], horizontal=True, key="uploaded_product_menu")

    st.divider()

    # ì„±ê³µ ë©”ì‹œì§€
    if st.session_state.get("_product_upload_success"):
        st.success(st.session_state["_product_upload_success"])
        del st.session_state["_product_upload_success"]

    # â”€â”€ ì œí’ˆ ëª©ë¡ â”€â”€
    if menu == "ğŸ“‹ ì œí’ˆ ëª©ë¡":
        st.subheader("ë“±ë¡ëœ ì œí’ˆ ëª©ë¡")
        st.caption("ì œí’ˆ ì—…ë¡œë“œ íƒ­ì—ì„œ ë“±ë¡ëœ ì œí’ˆì…ë‹ˆë‹¤. ìŠ¤ì¼€ì¤„ ìƒì„± ì‹œ ì´ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")

        df = load_uploaded_products()

        if df.empty:
            st.info("ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤. 'ì—‘ì…€ ì—…ë¡œë“œ'ì—ì„œ ë¨¼ì € ì œí’ˆì„ ë“±ë¡í•´ì£¼ì„¸ìš”.")
        else:
            # ê²€ìƒ‰
            search = st.text_input("ğŸ” ì œí’ˆ ê²€ìƒ‰", placeholder="ì œí’ˆì½”ë“œ ë˜ëŠ” ì œí’ˆëª… ì…ë ¥...", key="up_prod_search")
            filtered = df.copy()
            if search:
                mask = (
                    filtered["product_name"].astype(str).str.contains(search, case=False, na=False) |
                    filtered["product_code"].astype(str).str.contains(search, case=False, na=False)
                )
                filtered = filtered[mask]

            # ë©”íŠ¸ë¦­
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("ì œí’ˆ ìˆ˜", f"{len(filtered)}ê°œ")
            with col2:
                has_min_qty = (filtered["minimum_production_quantity"].fillna(0).astype(int) > 0).sum()
                st.metric("ìµœì†Œìƒì‚°ìˆ˜ëŸ‰ ì„¤ì •", f"{has_min_qty}ê°œ")
            with col3:
                origins = filtered["origin"].fillna("").astype(str).str.strip()
                st.metric("ì›ì‚°ì§€ ì¢…ë¥˜", f"{origins[origins != ''].nunique()}ê°œ")
            with col4:
                total_stock = filtered["current_stock"].fillna(0).astype(int).sum()
                st.metric("ì´ ì¬ê³ ", f"{total_stock:,}ê°œ")

            st.divider()

            if filtered.empty:
                st.info("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                # ì¸ë¼ì¸ í¸ì§‘ ê°€ëŠ¥ í…Œì´ë¸”
                edit_df = filtered[["product_code", "product_name", "origin", "kg_per_box",
                                    "production_time_per_unit", "production_point",
                                    "minimum_production_quantity", "current_stock"]].copy()

                edit_df["kg_per_box"] = pd.to_numeric(edit_df["kg_per_box"], errors="coerce").fillna(0)
                edit_df["production_time_per_unit"] = edit_df["production_time_per_unit"].fillna(0).astype(int)
                edit_df["production_point"] = edit_df["production_point"].fillna("ì£¼ì•¼").astype(str)
                edit_df["minimum_production_quantity"] = edit_df["minimum_production_quantity"].fillna(0).astype(int)
                edit_df["current_stock"] = edit_df["current_stock"].fillna(0).astype(int)

                edit_df = edit_df.rename(columns={
                    "product_code": "ìƒí’ˆì½”ë“œ",
                    "product_name": "ìƒí’ˆëª…",
                    "origin": "ì›ì‚°ì§€",
                    "kg_per_box": "ë°•ìŠ¤ë‹¹kg",
                    "production_time_per_unit": "ìƒì‚°ì‹œê°„(ì´ˆ)",
                    "production_point": "ìƒì‚°ì‹œì ",
                    "minimum_production_quantity": "ìµœì†Œìƒì‚°ìˆ˜ëŸ‰",
                    "current_stock": "í˜„ì¬ê³ ",
                })

                edited = st.data_editor(
                    edit_df,
                    use_container_width=True,
                    hide_index=True,
                    key="uploaded_prod_editor",
                    disabled=["ìƒí’ˆì½”ë“œ", "ìƒí’ˆëª…"],
                    column_config={
                        "ìƒí’ˆì½”ë“œ": st.column_config.TextColumn("ìƒí’ˆì½”ë“œ", width="medium"),
                        "ìƒí’ˆëª…": st.column_config.TextColumn("ìƒí’ˆëª…", width="large"),
                        "ì›ì‚°ì§€": st.column_config.TextColumn("ì›ì‚°ì§€", width="small"),
                        "ë°•ìŠ¤ë‹¹kg": st.column_config.NumberColumn("ë°•ìŠ¤ë‹¹kg", width="small", min_value=0, format="%.2f"),
                        "ìƒì‚°ì‹œê°„(ì´ˆ)": st.column_config.NumberColumn("ìƒì‚°ì‹œê°„(ì´ˆ)", width="small", min_value=0, step=1),
                        "ìƒì‚°ì‹œì ": st.column_config.SelectboxColumn("ìƒì‚°ì‹œì ", width="small", options=["ì£¼ì•¼", "ì£¼", "ì•¼"]),
                        "ìµœì†Œìƒì‚°ìˆ˜ëŸ‰": st.column_config.NumberColumn("ìµœì†Œìƒì‚°ìˆ˜ëŸ‰", width="small", min_value=0, step=1),
                        "í˜„ì¬ê³ ": st.column_config.NumberColumn("í˜„ì¬ê³ ", width="small", min_value=0, step=1),
                    }
                )

                # ë³€ê²½ ê°ì§€
                original = edit_df.reset_index(drop=True)
                changed = edited.reset_index(drop=True)

                diff_mask = (
                    (original["ì›ì‚°ì§€"] != changed["ì›ì‚°ì§€"]) |
                    (original["ë°•ìŠ¤ë‹¹kg"] != changed["ë°•ìŠ¤ë‹¹kg"]) |
                    (original["ìƒì‚°ì‹œê°„(ì´ˆ)"] != changed["ìƒì‚°ì‹œê°„(ì´ˆ)"]) |
                    (original["ìƒì‚°ì‹œì "].astype(str) != changed["ìƒì‚°ì‹œì "].astype(str)) |
                    (original["ìµœì†Œìƒì‚°ìˆ˜ëŸ‰"] != changed["ìµœì†Œìƒì‚°ìˆ˜ëŸ‰"]) |
                    (original["í˜„ì¬ê³ "] != changed["í˜„ì¬ê³ "])
                )
                changed_rows = changed[diff_mask]

                if len(changed_rows) > 0:
                    st.info(f"âœï¸ **{len(changed_rows)}ê°œ** ì œí’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
                    if st.button("ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥", type="primary", key="save_uploaded_prod"):
                        for _, row in changed_rows.iterrows():
                            supabase.table("uploaded_products").update({
                                "origin": str(row["ì›ì‚°ì§€"]).strip(),
                                "kg_per_box": float(row["ë°•ìŠ¤ë‹¹kg"]),
                                "production_time_per_unit": int(row["ìƒì‚°ì‹œê°„(ì´ˆ)"]),
                                "production_point": str(row["ìƒì‚°ì‹œì "]).strip(),
                                "minimum_production_quantity": int(row["ìµœì†Œìƒì‚°ìˆ˜ëŸ‰"]),
                                "current_stock": int(row["í˜„ì¬ê³ "]),
                            }).eq("product_code", row["ìƒí’ˆì½”ë“œ"]).execute()
                        load_uploaded_products.clear()
                        _clear_schedule_caches()
                        st.success(f"âœ… {len(changed_rows)}ê°œ ì œí’ˆ ìˆ˜ì • ì™„ë£Œ!")
                        st.rerun()

            # ì‚­ì œ
            st.divider()
            st.subheader("ğŸ—‘ï¸ ì œí’ˆ ì‚­ì œ")
            if not df.empty:
                delete_options = df.apply(lambda r: f"{r['product_code']} - {r['product_name']}", axis=1).tolist()
                delete_targets = st.multiselect(
                    "ì‚­ì œí•  ì œí’ˆ ì„ íƒ", options=delete_options,
                    placeholder="ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”...", key="up_prod_delete_targets"
                )
                if delete_targets:
                    st.warning(f"âš ï¸ ì„ íƒëœ {len(delete_targets)}ê°œ ì œí’ˆì´ ì‚­ì œë©ë‹ˆë‹¤.")
                    if st.button(f"ğŸ—‘ï¸ {len(delete_targets)}ê°œ ì‚­ì œ", type="primary", key="up_prod_delete_btn"):
                        deleted = 0
                        for target in delete_targets:
                            try:
                                p_code = target.split(" - ")[0].strip()
                                match = df[df["product_code"] == p_code]
                                if not match.empty:
                                    delete_uploaded_product(match.iloc[0]["id"])
                                    deleted += 1
                            except Exception as e:
                                st.error(f"âŒ '{target}' ì‚­ì œ ì‹¤íŒ¨: {str(e)}")
                        if deleted > 0:
                            st.success(f"âœ… {deleted}ê°œ ì œí’ˆ ì‚­ì œ ì™„ë£Œ!")
                            st.rerun()

    # â”€â”€ ì—‘ì…€ ì—…ë¡œë“œ â”€â”€
    elif menu == "ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ":
        st.subheader("ì œí’ˆ ì—‘ì…€ ì—…ë¡œë“œ")
        st.caption("ì—‘ì…€/CSV íŒŒì¼ë¡œ ì œí’ˆì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤. ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìƒí’ˆì½”ë“œëŠ” ìë™ìœ¼ë¡œ ìˆ˜ì •ë©ë‹ˆë‹¤.")
        st.markdown("""
        **ì—…ë¡œë“œ ì–‘ì‹ (ì»¬ëŸ¼ëª…)**
        | ìƒí’ˆì½”ë“œ | ìƒí’ˆëª… | ì›ì‚°ì§€ | ë°•ìŠ¤ë‹¹kg | ìƒì‚°ì‹œê°„(ì´ˆ) | ìƒì‚°ì‹œì  | ìµœì†Œìƒì‚°ìˆ˜ëŸ‰ |
        |---------|-------|-------|---------|------------|---------|------------|
        | E0000001 | ì†Œì‚¼ê²¹ì–‘ì§€ 1kg*10 | ë¯¸êµ­ | 10.0 | 120 | ì£¼ì•¼ | 5 |
        """)

        uploaded_file = st.file_uploader(
            "ì—‘ì…€ ë˜ëŠ” CSV íŒŒì¼ ì—…ë¡œë“œ",
            type=["xlsx", "xls", "csv"],
            key="product_upload_file"
        )

        if uploaded_file:
            try:
                if uploaded_file.name.endswith(".csv"):
                    df_upload = pd.read_csv(uploaded_file)
                else:
                    df_upload = pd.read_excel(uploaded_file)

                # ì»¬ëŸ¼ ë§¤í•‘
                col_map = {}
                for col in df_upload.columns:
                    col_clean = str(col).strip().replace(" ", "")
                    if "ìƒí’ˆì½”ë“œ" in col_clean or "ì œí’ˆì½”ë“œ" in col_clean or "ì½”ë“œ" == col_clean:
                        col_map[col] = "product_code"
                    elif "ìƒí’ˆëª…" in col_clean or "ì œí’ˆëª…" in col_clean:
                        if "ì½”ë“œ" not in col_clean:
                            col_map[col] = "product_name"
                    elif "ì›ì‚°ì§€" in col_clean:
                        col_map[col] = "origin"
                    elif "ë°•ìŠ¤ë‹¹" in col_clean or "kg/box" in col_clean.lower():
                        col_map[col] = "kg_per_box"
                    elif "ìƒì‚°ì‹œê°„" in col_clean:
                        col_map[col] = "production_time_per_unit"
                    elif "ìƒì‚°ì‹œì " in col_clean:
                        col_map[col] = "production_point"
                    elif "ìµœì†Œìƒì‚°" in col_clean or "ìµœì†Œìˆ˜ëŸ‰" in col_clean:
                        col_map[col] = "minimum_production_quantity"

                if col_map:
                    df_upload = df_upload.rename(columns=col_map)

                # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
                required = ["product_code", "product_name"]
                missing = [c for c in required if c not in df_upload.columns]
                if missing:
                    st.error(f"í•„ìˆ˜ ì»¬ëŸ¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: {', '.join(missing)}")
                    st.info("í•„ìˆ˜: ìƒí’ˆì½”ë“œ, ìƒí’ˆëª… / ì„ íƒ: ì›ì‚°ì§€, ë°•ìŠ¤ë‹¹kg, ìƒì‚°ì‹œê°„(ì´ˆ), ìƒì‚°ì‹œì , ìµœì†Œìƒì‚°ìˆ˜ëŸ‰")
                else:
                    # ì„ íƒ ì»¬ëŸ¼ ê¸°ë³¸ê°’
                    if "origin" not in df_upload.columns:
                        df_upload["origin"] = ""
                    if "kg_per_box" not in df_upload.columns:
                        df_upload["kg_per_box"] = 0
                    if "production_time_per_unit" not in df_upload.columns:
                        df_upload["production_time_per_unit"] = 0
                    if "production_point" not in df_upload.columns:
                        df_upload["production_point"] = "ì£¼ì•¼"
                    if "minimum_production_quantity" not in df_upload.columns:
                        df_upload["minimum_production_quantity"] = 0

                    # ë°ì´í„° ì •ë¦¬
                    df_upload["product_code"] = df_upload["product_code"].fillna("").astype(str).str.strip()
                    df_upload["product_name"] = df_upload["product_name"].fillna("").astype(str).str.strip()
                    df_upload["origin"] = df_upload["origin"].fillna("").astype(str).str.strip()
                    df_upload["kg_per_box"] = pd.to_numeric(df_upload["kg_per_box"], errors="coerce").fillna(0)
                    df_upload["production_time_per_unit"] = pd.to_numeric(df_upload["production_time_per_unit"], errors="coerce").fillna(0).astype(int)
                    df_upload["production_point"] = df_upload["production_point"].fillna("ì£¼ì•¼").astype(str).str.strip()
                    df_upload["minimum_production_quantity"] = pd.to_numeric(df_upload["minimum_production_quantity"], errors="coerce").fillna(0).astype(int)

                    # ìœ íš¨í•œ í–‰ë§Œ
                    valid = df_upload[
                        (df_upload["product_code"] != "") &
                        (df_upload["product_name"] != "")
                    ].copy()

                    if valid.empty:
                        st.warning("ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆì½”ë“œ, ìƒí’ˆëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
                    else:
                        st.success(f"ì´ {len(valid)}ê±´ì˜ ìœ íš¨í•œ ë°ì´í„°ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.")

                        # ë¯¸ë¦¬ë³´ê¸°
                        preview = valid[["product_code", "product_name", "origin", "kg_per_box",
                                         "production_time_per_unit", "production_point",
                                         "minimum_production_quantity"]].copy()
                        preview = preview.rename(columns={
                            "product_code": "ìƒí’ˆì½”ë“œ",
                            "product_name": "ìƒí’ˆëª…",
                            "origin": "ì›ì‚°ì§€",
                            "kg_per_box": "ë°•ìŠ¤ë‹¹kg",
                            "production_time_per_unit": "ìƒì‚°ì‹œê°„(ì´ˆ)",
                            "production_point": "ìƒì‚°ì‹œì ",
                            "minimum_production_quantity": "ìµœì†Œìƒì‚°ìˆ˜ëŸ‰",
                        })
                        st.dataframe(preview, use_container_width=True, hide_index=True)

                        if st.button("ğŸ’¾ ì—…ë¡œë“œ í™•ì •", type="primary", use_container_width=True, key="product_upload_confirm"):
                            rows = []
                            for _, r in valid.iterrows():
                                rows.append({
                                    "product_code": r["product_code"],
                                    "product_name": r["product_name"],
                                    "origin": r["origin"],
                                    "kg_per_box": float(r["kg_per_box"]),
                                    "production_time_per_unit": int(r["production_time_per_unit"]),
                                    "production_point": r["production_point"],
                                    "minimum_production_quantity": int(r["minimum_production_quantity"]),
                                })
                            try:
                                upsert_uploaded_products_bulk(rows)
                                st.session_state["_product_upload_success"] = f"âœ… {len(rows)}ê±´ ì—…ë¡œë“œ ì™„ë£Œ!"
                                st.rerun()
                            except Exception as e:
                                st.error(f"âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: {str(e)}")

            except Exception as e:
                st.error(f"âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {str(e)}")

    # â”€â”€ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ â”€â”€
    elif menu == "ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ":
        st.subheader("ì œí’ˆ ëª©ë¡ ë‹¤ìš´ë¡œë“œ")

        df = load_uploaded_products()

        if df.empty:
            st.info("ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.")
        else:
            st.caption(f"ì´ {len(df)}ê°œ ì œí’ˆ")

            display_df = df[["product_code", "product_name", "origin", "kg_per_box",
                             "production_time_per_unit", "production_point",
                             "minimum_production_quantity", "current_stock"]].copy()
            display_df = display_df.rename(columns={
                "product_code": "ìƒí’ˆì½”ë“œ",
                "product_name": "ìƒí’ˆëª…",
                "origin": "ì›ì‚°ì§€",
                "kg_per_box": "ë°•ìŠ¤ë‹¹kg",
                "production_time_per_unit": "ìƒì‚°ì‹œê°„(ì´ˆ)",
                "production_point": "ìƒì‚°ì‹œì ",
                "minimum_production_quantity": "ìµœì†Œìƒì‚°ìˆ˜ëŸ‰",
                "current_stock": "í˜„ì¬ê³ ",
            })
            st.dataframe(display_df, use_container_width=True, hide_index=True)

            output = BytesIO()
            with pd.ExcelWriter(output, engine="openpyxl") as writer:
                display_df.to_excel(writer, index=False, sheet_name="ì œí’ˆëª©ë¡")

            st.download_button(
                label="ğŸ’¾ Excel ë‹¤ìš´ë¡œë“œ",
                data=output.getvalue(),
                file_name="ì œí’ˆëª©ë¡_ì—…ë¡œë“œ.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                key="up_prod_download_btn"
            )

    # â”€â”€ ì¬ê³  ê´€ë¦¬ â”€â”€
    elif menu == "ğŸ“¦ ì¬ê³  ê´€ë¦¬":
        st.subheader("ğŸ“¦ ì¬ê³  ê´€ë¦¬")
        st.caption("ğŸ’¡ 'í˜„ì¬ê³ ' ì…€ì„ ì§ì ‘ í´ë¦­í•˜ì—¬ ìˆ˜ì •í•œ ë’¤ ì €ì¥ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.")

        df = load_uploaded_products()

        if df.empty:
            st.info("ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤. 'ì—‘ì…€ ì—…ë¡œë“œ'ì—ì„œ ë¨¼ì € ì œí’ˆì„ ë“±ë¡í•´ì£¼ì„¸ìš”.")
        else:
            df["current_stock"] = df["current_stock"].fillna(0).astype(int)

            # ê²€ìƒ‰
            search = st.text_input("ğŸ” ê²€ìƒ‰", placeholder="ì œí’ˆì½”ë“œ ë˜ëŠ” ì œí’ˆëª… ì…ë ¥...", key="up_inv_search")
            filtered = df.copy()
            if search:
                mask = (
                    filtered["product_name"].astype(str).str.contains(search, case=False, na=False) |
                    filtered["product_code"].astype(str).str.contains(search, case=False, na=False)
                )
                filtered = filtered[mask]

            st.divider()

            # ë©”íŠ¸ë¦­
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("ì œí’ˆ ìˆ˜", f"{len(filtered)}ê°œ")
            with col2:
                st.metric("ì´ ì¬ê³ ", f"{filtered['current_stock'].sum():,}ê°œ")
            with col3:
                zero_stock = (filtered["current_stock"] == 0).sum()
                st.metric("ì¬ê³  ì—†ìŒ", f"{zero_stock}ê°œ")

            st.divider()

            if filtered.empty:
                st.info("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                edit_df = filtered[["product_code", "product_name", "current_stock"]].copy()
                edit_df["current_stock"] = edit_df["current_stock"].fillna(0).astype(int)
                edit_df = edit_df.rename(columns={
                    "product_code": "ìƒí’ˆì½”ë“œ",
                    "product_name": "ìƒí’ˆëª…",
                    "current_stock": "í˜„ì¬ê³ "
                })

                edited = st.data_editor(
                    edit_df,
                    use_container_width=True,
                    hide_index=True,
                    key="up_inventory_editor",
                    disabled=["ìƒí’ˆì½”ë“œ", "ìƒí’ˆëª…"],
                    column_config={
                        "ìƒí’ˆì½”ë“œ": st.column_config.TextColumn("ìƒí’ˆì½”ë“œ", width="medium"),
                        "ìƒí’ˆëª…": st.column_config.TextColumn("ìƒí’ˆëª…", width="large"),
                        "í˜„ì¬ê³ ": st.column_config.NumberColumn("í˜„ì¬ê³ ", width="medium", min_value=0, step=1, format="%d"),
                    }
                )

                original = edit_df.reset_index(drop=True)
                changed = edited.reset_index(drop=True)
                diff_mask = original["í˜„ì¬ê³ "] != changed["í˜„ì¬ê³ "]
                changed_rows = changed[diff_mask]

                if len(changed_rows) > 0:
                    st.info(f"âœï¸ **{len(changed_rows)}ê°œ** ì œí’ˆì˜ ì¬ê³ ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")

                    with st.expander("ë³€ê²½ ë‚´ì—­ í™•ì¸", expanded=True):
                        preview = changed_rows.copy()
                        preview["ê¸°ì¡´ ì¬ê³ "] = original.loc[diff_mask, "í˜„ì¬ê³ "].values
                        preview = preview[["ìƒí’ˆì½”ë“œ", "ìƒí’ˆëª…", "ê¸°ì¡´ ì¬ê³ ", "í˜„ì¬ê³ "]]
                        st.dataframe(preview, use_container_width=True, hide_index=True)

                    if st.button("ğŸ’¾ ì¬ê³  ì €ì¥", type="primary", key="up_inv_save_btn"):
                        updates = []
                        for _, row in changed_rows.iterrows():
                            stock = row["í˜„ì¬ê³ "]
                            stock = 0 if pd.isna(stock) else int(stock)
                            updates.append({"product_code": row["ìƒí’ˆì½”ë“œ"], "current_stock": stock})
                        update_uploaded_product_stocks_bulk(updates)
                        st.success(f"âœ… {len(updates)}ê°œ ì œí’ˆ ì¬ê³  ì €ì¥ ì™„ë£Œ!")
                        st.rerun()


# ========================
# Tab 2: ì œí’ˆ-ì›ìœ¡ ë§¤í•‘ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
# ========================

with tab2:
    st.subheader("ğŸ“¦ ì œí’ˆ-ì›ìœ¡ ë§¤í•‘")
    st.caption("ë¡œìŠ¤ ë°ì´í„°ì—ì„œ ìë™ ìƒì„±ëœ ì œí’ˆ-ì›ìœ¡ ë§¤í•‘ì„ í™•ì¸í•©ë‹ˆë‹¤.")

    sync_product_rawmeats()

    mapping_df = load_product_rawmeats()

    if mapping_df.empty:
        st.info("ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œìŠ¤ ë°ì´í„°ì—ì„œ íˆ¬ì…ìƒí’ˆ ìƒì‚°í˜„í™© ì—…ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.")
    else:
        products = sorted(mapping_df["product_name"].unique().tolist())
        meat_count = mapping_df[["meat_code", "meat_name"]].drop_duplicates().shape[0]

        col1, col2 = st.columns(2)
        with col1:
            st.metric("ë“±ë¡ ì œí’ˆ ìˆ˜", f"{len(products)}ê°œ")
        with col2:
            st.metric("ì‚¬ìš© ì›ìœ¡ ì¢…ë¥˜", f"{meat_count}ê°œ")

        st.divider()

        search = st.text_input("ğŸ” ì œí’ˆ ê²€ìƒ‰", placeholder="ì œí’ˆëª… ì…ë ¥...", key="product_info_search")

        filtered_products = products
        if search:
            filtered_products = [p for p in products if search.lower() in p.lower()]

        if not filtered_products:
            st.info("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            for product in filtered_products:
                product_meats = mapping_df[mapping_df["product_name"] == product]

                with st.expander(f"ğŸ“¦ {product} ({len(product_meats)}ê°œ ì›ìœ¡)", expanded=False):
                    display_data = []
                    for _, row in product_meats.iterrows():
                        display_data.append({
                            "ì›ìœ¡ì½”ë“œ": row.get("meat_code", ""),
                            "ì›ìœ¡ëª…": row.get("meat_name", ""),
                            "ì›ì‚°ì§€(ë“±ê¸‰)": row.get("origin_grade", ""),
                        })

                    display_df = pd.DataFrame(display_data)
                    st.dataframe(display_df, use_container_width=True, hide_index=True)
