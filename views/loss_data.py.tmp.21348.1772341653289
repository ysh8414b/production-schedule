import streamlit as st
import pandas as pd
from datetime import date
from supabase import create_client
from views.sales import (
    supabase,
    load_loss_assignments,
    sync_product_rawmeats,
    upsert_product_rawmeat,
)

# ========================
# DB í•¨ìˆ˜ (production_status)
# ========================

@st.cache_data(ttl=120)
def load_production_status_uploads():
    """ì—…ë¡œë“œ ë°°ì¹˜ ëª©ë¡ ì¡°íšŒ"""
    try:
        result = supabase.table("production_status_uploads").select("*").order("upload_date", desc=True).execute()
        if result.data:
            return pd.DataFrame(result.data)
    except:
        pass
    return pd.DataFrame(columns=["id", "upload_date", "file_name", "total_groups",
                                  "total_input_kg", "total_output_kg", "total_loss_kg"])


@st.cache_data(ttl=120)
def load_production_status_groups(upload_id=None):
    """ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ"""
    try:
        query = supabase.table("production_status_groups").select("*").order("group_index")
        if upload_id:
            query = query.eq("upload_id", upload_id)
        result = query.execute()
        if result.data:
            return pd.DataFrame(result.data)
    except:
        pass
    return pd.DataFrame(columns=["id", "upload_id", "group_index", "total_input_kg",
                                  "total_output_kg", "loss_kg", "loss_rate",
                                  "total_input_amount", "total_output_amount"])


@st.cache_data(ttl=120)
def load_production_status_items(group_id=None):
    """í•­ëª© ëª©ë¡ ì¡°íšŒ"""
    try:
        query = supabase.table("production_status_items").select("*").order("id")
        if group_id:
            query = query.eq("group_id", group_id)
        result = query.execute()
        if result.data:
            return pd.DataFrame(result.data)
    except:
        pass
    return pd.DataFrame()


def _clear_production_status_caches():
    """ìºì‹œ í´ë¦¬ì–´"""
    load_production_status_uploads.clear()
    load_production_status_groups.clear()
    load_production_status_items.clear()


def insert_production_status(upload_data, groups_with_items):
    """
    ìƒì‚°í˜„í™© ë°ì´í„° ì¼ê´„ ì €ì¥.
    upload_data: dict (upload_date, file_name, total_groups, total_input_kg, total_output_kg, total_loss_kg)
    groups_with_items: list of dict, each with:
        group_data: dict (group_index, total_input_kg, total_output_kg, loss_kg, loss_rate, ...)
        items: list of dict (item rows)
    """
    # 1. ì—…ë¡œë“œ ë°°ì¹˜ ìƒì„±
    upload_result = supabase.table("production_status_uploads").insert(upload_data).execute()
    upload_id = upload_result.data[0]["id"]

    # 2. ê·¸ë£¹ë³„ ì €ì¥
    for group_info in groups_with_items:
        group_data = group_info["group_data"].copy()
        group_data["upload_id"] = upload_id

        group_result = supabase.table("production_status_groups").insert(group_data).execute()
        group_id = group_result.data[0]["id"]

        # 3. í•­ëª© ì €ì¥
        items = group_info["items"]
        if items:
            for item in items:
                item["group_id"] = group_id
            # 500ê±´ì”© ë‚˜ëˆ  ì €ì¥
            chunk_size = 500
            for i in range(0, len(items), chunk_size):
                chunk = items[i:i + chunk_size]
                supabase.table("production_status_items").insert(chunk).execute()

    _clear_production_status_caches()
    return upload_id


def delete_production_status_upload(upload_id):
    """ì—…ë¡œë“œ ë°°ì¹˜ ì‚­ì œ (CASCADEë¡œ groups, items ìë™ ì‚­ì œ)"""
    supabase.table("production_status_uploads").delete().eq("id", upload_id).execute()
    _clear_production_status_caches()


# ========================
# uploaded_products ì¡°íšŒ (ë¡œìŠ¤ ê³„ì‚°ìš©)
# ========================

@st.cache_data(ttl=120)
def _load_uploaded_products_for_loss():
    """uploaded_productsì—ì„œ ë°•ìŠ¤ë‹¹kg ì¡°íšŒ"""
    try:
        result = supabase.table("uploaded_products").select("product_code, product_name, kg_per_box").execute()
        if result.data:
            return pd.DataFrame(result.data)
    except:
        pass
    return pd.DataFrame(columns=["product_code", "product_name", "kg_per_box"])


# ========================
# ì—‘ì…€ íŒŒì‹± ë° ê·¸ë£¹í•‘ ë¡œì§
# ========================

def parse_production_excel(df_raw):
    """
    íˆ¬ì…ìƒí’ˆ ê¸°ì¤€ ìƒì‚°í˜„í™© ì—‘ì…€ì„ íŒŒì‹±í•˜ì—¬ ê·¸ë£¹ìœ¼ë¡œ ë¶„ë¦¬.

    ì—‘ì…€ êµ¬ì¡° (ì»¬ëŸ¼ ì¸ë±ìŠ¤ ê¸°ì¤€):
    0-7: ì›ìœ¡ (ì›ìœ¡ì½”ë“œ/ì›ìœ¡ëª…/ì›ì‚°ì§€/ë“±ê¸‰/Box/ì¤‘ëŸ‰Kg/ë‹¨ìœ„/ê¸ˆì•¡)
    8-15: ìƒí’ˆ (ìƒí’ˆì½”ë“œ/ìƒí’ˆëª…/ì›ì‚°ì§€/ë“±ê¸‰/Box/ì¤‘ëŸ‰Kg/ë‹¨ìœ„/ê¸ˆì•¡)
    16-17: ì˜ˆìƒíŒë§¤ê¸ˆì•¡/ì˜ˆìƒì´ìµê¸ˆì•¡

    ë°˜í™˜: list of groups, ê° group = {"raw_meats": [...], "products": [...]}
    """
    groups = []
    current_group = {"raw_meats": [], "products": []}

    for idx in range(len(df_raw)):
        row = df_raw.iloc[idx]

        # ë¹ˆ í–‰ ê°ì§€ (ê·¸ë£¹ êµ¬ë¶„ì)
        if _is_empty_row(row):
            if current_group["raw_meats"] or current_group["products"]:
                groups.append(current_group)
                current_group = {"raw_meats": [], "products": []}
            continue

        # ì›ìœ¡/ìƒí’ˆ ë°ì´í„° ì¶”ì¶œ
        meat_data = _extract_meat_data(row)
        product_data = _extract_product_data(row)

        has_meat = bool(str(meat_data.get("meat_code", "")).strip() or str(meat_data.get("meat_name", "")).strip())
        has_product = bool(str(product_data.get("product_code", "")).strip() or str(product_data.get("product_name", "")).strip())

        if has_meat:
            current_group["raw_meats"].append(meat_data)
        if has_product:
            product_data["expected_sales_amount"] = _safe_float(row, 16)
            product_data["expected_profit_amount"] = _safe_float(row, 17)
            current_group["products"].append(product_data)

    # ë§ˆì§€ë§‰ ê·¸ë£¹
    if current_group["raw_meats"] or current_group["products"]:
        groups.append(current_group)

    return groups


def _is_empty_row(row):
    """í–‰ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸"""
    for v in row.values:
        if pd.notna(v) and str(v).strip() != "":
            return False
    return True


def _safe_float(row, col_idx):
    """ì•ˆì „í•˜ê²Œ float ë³€í™˜"""
    try:
        if col_idx < len(row):
            v = row.iloc[col_idx]
            if pd.notna(v):
                return float(v)
    except (ValueError, TypeError):
        pass
    return 0.0


def _safe_str(row, col_idx):
    """ì•ˆì „í•˜ê²Œ string ë³€í™˜"""
    try:
        if col_idx < len(row):
            v = row.iloc[col_idx]
            if pd.notna(v):
                return str(v).strip()
    except:
        pass
    return ""


def _extract_meat_data(row):
    """ì›ìœ¡ ë°ì´í„° ì¶”ì¶œ (ì»¬ëŸ¼ 0-7)"""
    return {
        "meat_code": _safe_str(row, 0),
        "meat_name": _safe_str(row, 1),
        "meat_origin": _safe_str(row, 2),
        "meat_grade": _safe_str(row, 3),
        "meat_boxes": _safe_float(row, 4),
        "meat_kg": _safe_float(row, 5),
        "meat_unit": _safe_str(row, 6),
        "meat_amount": _safe_float(row, 7),
    }


def _extract_product_data(row):
    """ìƒí’ˆ ë°ì´í„° ì¶”ì¶œ (ì»¬ëŸ¼ 8-15)"""
    return {
        "product_code": _safe_str(row, 8),
        "product_name": _safe_str(row, 9),
        "product_origin": _safe_str(row, 10),
        "product_grade": _safe_str(row, 11),
        "product_boxes": _safe_float(row, 12),
        "product_kg": _safe_float(row, 13),
        "product_unit": _safe_str(row, 14),
        "product_amount": _safe_float(row, 15),
    }


def calculate_group_loss(group, uploaded_products_df):
    """
    ê·¸ë£¹ ë‚´ ë¡œìŠ¤ ê³„ì‚°.
    íˆ¬ì… ì›ìœ¡ kg í•©ê³„ vs ìƒì‚° ì œí’ˆ kg í•©ê³„ (ì—‘ì…€ì— kg ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ boxes Ã— kg_per_box)
    """
    total_input_kg = sum(m["meat_kg"] for m in group["raw_meats"])
    total_input_amount = sum(m["meat_amount"] for m in group["raw_meats"])

    total_output_kg = 0.0
    total_output_amount = 0.0

    for prod in group["products"]:
        # ì—‘ì…€ì— kg ê°’ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        if prod["product_kg"] > 0:
            total_output_kg += prod["product_kg"]
        elif prod["product_boxes"] > 0 and not uploaded_products_df.empty:
            # boxes Ã— kg_per_box ê³„ì‚°
            match = uploaded_products_df[
                uploaded_products_df["product_code"] == prod["product_code"]
            ]
            if not match.empty:
                kg_per_box = float(match.iloc[0].get("kg_per_box", 0))
                total_output_kg += prod["product_boxes"] * kg_per_box

        total_output_amount += prod["product_amount"]

    loss_kg = total_input_kg - total_output_kg
    loss_rate = round((loss_kg / total_input_kg * 100), 2) if total_input_kg > 0 else 0

    return {
        "total_input_kg": round(total_input_kg, 2),
        "total_output_kg": round(total_output_kg, 2),
        "loss_kg": round(loss_kg, 2),
        "loss_rate": loss_rate,
        "total_input_amount": round(total_input_amount, 2),
        "total_output_amount": round(total_output_amount, 2),
    }


def sync_rawmeats_from_production_status(groups):
    """ìƒì‚°í˜„í™© ì—…ë¡œë“œ í›„ product_rawmeats ë™ê¸°í™”"""
    for group in groups:
        for product in group["products"]:
            p_name = str(product.get("product_name", "")).strip()
            p_code = str(product.get("product_code", "")).strip()
            if not p_name:
                continue
            for meat in group["raw_meats"]:
                m_code = str(meat.get("meat_code", "")).strip()
                m_name = str(meat.get("meat_name", "")).strip()
                m_origin = str(meat.get("meat_origin", "")).strip()
                m_grade = str(meat.get("meat_grade", "")).strip()
                origin_grade = f"{m_origin} {m_grade}".strip() if m_origin or m_grade else ""
                if m_code or m_name:
                    upsert_product_rawmeat(p_name, m_code, m_name, origin_grade)


# ========================
# í˜ì´ì§€ ë Œë”ë§
# ========================

st.title("ğŸ“‰ ë¡œìŠ¤ ë°ì´í„°")
st.caption("íˆ¬ì…ìƒí’ˆ ê¸°ì¤€ ìƒì‚°í˜„í™© ì—…ë¡œë“œ ë° ë¡œìŠ¤ ê´€ë¦¬")

tab1, tab2 = st.tabs(["ğŸ“‹ íˆ¬ì…ìƒí’ˆ ê¸°ì¤€ ìƒì‚°í˜„í™©", "ğŸ“Š ë¡œìŠ¤ í˜„í™©"])

# ========================
# Tab 1: íˆ¬ì…ìƒí’ˆ ê¸°ì¤€ ìƒì‚°í˜„í™©
# ========================

with tab1:
    menu = st.radio("ì„ íƒ", [
        "ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ",
        "ğŸ“‹ ì—…ë¡œë“œ ì´ë ¥",
    ], horizontal=True, key="production_status_menu")

    st.divider()

    # ì„±ê³µ ë©”ì‹œì§€
    for msg_key in ["_ps_upload_success", "_ps_delete_success"]:
        if st.session_state.get(msg_key):
            st.success(st.session_state[msg_key])
            del st.session_state[msg_key]

    # â”€â”€ ì—‘ì…€ ì—…ë¡œë“œ â”€â”€
    if menu == "ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ":
        st.subheader("ğŸ“¤ íˆ¬ì…ìƒí’ˆ ê¸°ì¤€ ìƒì‚°í˜„í™© ì—…ë¡œë“œ")
        st.caption("ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë¹ˆ í–‰ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹ì„ ë¶„ë¦¬í•˜ê³  ë¡œìŠ¤ë¥¼ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤.")

        st.markdown("""
        **ì—‘ì…€ êµ¬ì¡°** (í—¤ë” í–‰ í¬í•¨)

        | ì›ìœ¡ì½”ë“œ | ì›ìœ¡ëª… | ì›ì‚°ì§€ | ë“±ê¸‰ | Box | ì¤‘ëŸ‰(Kg) | ë‹¨ìœ„ | ê¸ˆì•¡ | ìƒí’ˆì½”ë“œ | ìƒí’ˆëª… | ì›ì‚°ì§€ | ë“±ê¸‰ | Box | ì¤‘ëŸ‰(Kg) | ë‹¨ìœ„ | ê¸ˆì•¡ | ì˜ˆìƒíŒë§¤ê¸ˆì•¡ | ì˜ˆìƒì´ìµê¸ˆì•¡ |
        |---------|-------|-------|-----|-----|---------|-----|------|---------|-------|-------|-----|-----|---------|-----|------|-----------|-----------|

        - ë¹ˆ í–‰ìœ¼ë¡œ ê·¸ë£¹ì„ êµ¬ë¶„í•©ë‹ˆë‹¤
        - í•œ ê·¸ë£¹ ë‚´: ì›ìœ¡O ìƒí’ˆX = ì¶”ê°€ íˆ¬ì…ì›ìœ¡ / ì›ìœ¡X ìƒí’ˆO = ì¶”ê°€ ìƒì‚°ìƒí’ˆ
        """)

        uploaded_file = st.file_uploader(
            "ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ (.xlsx)",
            type=["xlsx", "xls"],
            key="production_status_upload_file"
        )

        if uploaded_file:
            try:
                # í—¤ë” í–‰(ì²« í–‰)ì„ ê±´ë„ˆë›°ê³  ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ì½ê¸°
                df_raw = pd.read_excel(uploaded_file, header=0)

                if df_raw.empty:
                    st.warning("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                else:
                    # ê·¸ë£¹ íŒŒì‹±
                    groups = parse_production_excel(df_raw)

                    if not groups:
                        st.warning("ìœ íš¨í•œ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
                    else:
                        # uploaded_productsì—ì„œ ë°•ìŠ¤ë‹¹kg ì¡°íšŒ
                        uploaded_prod_df = _load_uploaded_products_for_loss()

                        # ê·¸ë£¹ë³„ ë¡œìŠ¤ ê³„ì‚°
                        total_input_kg = 0.0
                        total_output_kg = 0.0
                        total_loss_kg = 0.0
                        groups_with_loss = []

                        for i, group in enumerate(groups):
                            loss_info = calculate_group_loss(group, uploaded_prod_df)
                            total_input_kg += loss_info["total_input_kg"]
                            total_output_kg += loss_info["total_output_kg"]
                            total_loss_kg += loss_info["loss_kg"]
                            groups_with_loss.append({
                                "group": group,
                                "loss_info": loss_info,
                                "index": i,
                            })

                        # ì „ì²´ ìš”ì•½
                        overall_loss_rate = round((total_loss_kg / total_input_kg * 100), 2) if total_input_kg > 0 else 0

                        st.success(f"ì´ **{len(groups)}ê°œ** ê·¸ë£¹ íŒŒì‹± ì™„ë£Œ")

                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.metric("ì´ íˆ¬ì…ëŸ‰", f"{total_input_kg:,.1f}kg")
                        with col2:
                            st.metric("ì´ ìƒì‚°ëŸ‰", f"{total_output_kg:,.1f}kg")
                        with col3:
                            st.metric("ì´ ë¡œìŠ¤", f"{total_loss_kg:,.1f}kg")
                        with col4:
                            st.metric("í‰ê·  ë¡œìŠ¤ìœ¨", f"{overall_loss_rate:.1f}%")

                        st.divider()

                        # ê·¸ë£¹ë³„ ìƒì„¸ ë¯¸ë¦¬ë³´ê¸°
                        for ginfo in groups_with_loss:
                            group = ginfo["group"]
                            loss = ginfo["loss_info"]
                            idx = ginfo["index"]

                            # ê·¸ë£¹ ë¼ë²¨
                            meat_names = [m["meat_name"] for m in group["raw_meats"] if m["meat_name"]]
                            prod_names = [p["product_name"] for p in group["products"] if p["product_name"]]
                            label = f"ê·¸ë£¹ {idx + 1}: {', '.join(meat_names[:2])} â†’ {', '.join(prod_names[:2])}"
                            if loss["loss_rate"] < 0:
                                label += f" (âš ï¸ ìƒì‚°ì´ˆê³¼ {loss['loss_rate']:.1f}%)"
                            else:
                                label += f" (ë¡œìŠ¤ {loss['loss_rate']:.1f}%)"

                            with st.expander(label, expanded=False):
                                # ì›ìœ¡
                                if group["raw_meats"]:
                                    st.markdown("**ğŸ¥© íˆ¬ì… ì›ìœ¡**")
                                    meat_display = []
                                    for m in group["raw_meats"]:
                                        meat_display.append({
                                            "ì›ìœ¡ì½”ë“œ": m["meat_code"],
                                            "ì›ìœ¡ëª…": m["meat_name"],
                                            "ì›ì‚°ì§€": m["meat_origin"],
                                            "ë“±ê¸‰": m["meat_grade"],
                                            "Box": m["meat_boxes"],
                                            "ì¤‘ëŸ‰(Kg)": m["meat_kg"],
                                            "ê¸ˆì•¡": m["meat_amount"],
                                        })
                                    st.dataframe(pd.DataFrame(meat_display), use_container_width=True, hide_index=True)

                                # ìƒí’ˆ
                                if group["products"]:
                                    st.markdown("**ğŸ“¦ ìƒì‚° ìƒí’ˆ**")
                                    prod_display = []
                                    for p in group["products"]:
                                        prod_display.append({
                                            "ìƒí’ˆì½”ë“œ": p["product_code"],
                                            "ìƒí’ˆëª…": p["product_name"],
                                            "ì›ì‚°ì§€": p["product_origin"],
                                            "ë“±ê¸‰": p["product_grade"],
                                            "Box": p["product_boxes"],
                                            "ì¤‘ëŸ‰(Kg)": p["product_kg"],
                                            "ê¸ˆì•¡": p["product_amount"],
                                        })
                                    st.dataframe(pd.DataFrame(prod_display), use_container_width=True, hide_index=True)

                                # ë¡œìŠ¤ ìš”ì•½
                                st.info(
                                    f"ğŸ“Š íˆ¬ì…: **{loss['total_input_kg']:,.1f}kg** "
                                    f"({loss['total_input_amount']:,.0f}ì›) â†’ "
                                    f"ìƒì‚°: **{loss['total_output_kg']:,.1f}kg** "
                                    f"({loss['total_output_amount']:,.0f}ì›) â†’ "
                                    f"ë¡œìŠ¤: **{loss['loss_kg']:,.1f}kg** "
                                    f"(**{loss['loss_rate']:.1f}%**)"
                                )

                        st.divider()

                        # ì €ì¥ ë²„íŠ¼
                        if st.button("ğŸ’¾ ì—…ë¡œë“œ í™•ì • ë° ì €ì¥", type="primary", use_container_width=True,
                                     key="ps_upload_confirm"):
                            try:
                                upload_data = {
                                    "upload_date": date.today().strftime("%Y-%m-%d"),
                                    "file_name": uploaded_file.name,
                                    "total_groups": len(groups),
                                    "total_input_kg": round(total_input_kg, 2),
                                    "total_output_kg": round(total_output_kg, 2),
                                    "total_loss_kg": round(total_loss_kg, 2),
                                }

                                save_groups = []
                                for ginfo in groups_with_loss:
                                    group = ginfo["group"]
                                    loss = ginfo["loss_info"]

                                    group_data = {
                                        "group_index": ginfo["index"],
                                        "total_input_kg": loss["total_input_kg"],
                                        "total_output_kg": loss["total_output_kg"],
                                        "loss_kg": loss["loss_kg"],
                                        "loss_rate": loss["loss_rate"],
                                        "total_input_amount": loss["total_input_amount"],
                                        "total_output_amount": loss["total_output_amount"],
                                    }

                                    items = []
                                    for m in group["raw_meats"]:
                                        items.append({
                                            "item_type": "raw_meat",
                                            "meat_code": m["meat_code"],
                                            "meat_name": m["meat_name"],
                                            "meat_origin": m["meat_origin"],
                                            "meat_grade": m["meat_grade"],
                                            "meat_boxes": m["meat_boxes"],
                                            "meat_kg": m["meat_kg"],
                                            "meat_unit": m["meat_unit"],
                                            "meat_amount": m["meat_amount"],
                                        })
                                    for p in group["products"]:
                                        items.append({
                                            "item_type": "product",
                                            "product_code": p["product_code"],
                                            "product_name": p["product_name"],
                                            "product_origin": p["product_origin"],
                                            "product_grade": p["product_grade"],
                                            "product_boxes": p["product_boxes"],
                                            "product_kg": p["product_kg"],
                                            "product_unit": p["product_unit"],
                                            "product_amount": p["product_amount"],
                                            "expected_sales_amount": p.get("expected_sales_amount", 0),
                                            "expected_profit_amount": p.get("expected_profit_amount", 0),
                                        })

                                    save_groups.append({
                                        "group_data": group_data,
                                        "items": items,
                                    })

                                insert_production_status(upload_data, save_groups)

                                # product_rawmeats ë™ê¸°í™”
                                sync_rawmeats_from_production_status(groups)

                                st.session_state["_ps_upload_success"] = f"âœ… {len(groups)}ê°œ ê·¸ë£¹ ì €ì¥ ì™„ë£Œ!"
                                st.rerun()

                            except Exception as e:
                                st.error(f"âŒ ì €ì¥ ì‹¤íŒ¨: {str(e)}")

            except Exception as e:
                st.error(f"âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {str(e)}")

    # â”€â”€ ì—…ë¡œë“œ ì´ë ¥ â”€â”€
    elif menu == "ğŸ“‹ ì—…ë¡œë“œ ì´ë ¥":
        st.subheader("ğŸ“‹ ì—…ë¡œë“œ ì´ë ¥")

        uploads_df = load_production_status_uploads()

        if uploads_df.empty:
            st.info("ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            # ìš”ì•½ í…Œì´ë¸”
            display_data = []
            for _, row in uploads_df.iterrows():
                total_input = float(row.get("total_input_kg", 0) or 0)
                total_output = float(row.get("total_output_kg", 0) or 0)
                total_loss = float(row.get("total_loss_kg", 0) or 0)
                loss_rate = round((total_loss / total_input * 100), 1) if total_input > 0 else 0

                display_data.append({
                    "ì—…ë¡œë“œì¼": row.get("upload_date", ""),
                    "íŒŒì¼ëª…": row.get("file_name", ""),
                    "ê·¸ë£¹ìˆ˜": int(row.get("total_groups", 0) or 0),
                    "ì´íˆ¬ì…(kg)": total_input,
                    "ì´ìƒì‚°(kg)": total_output,
                    "ì´ë¡œìŠ¤(kg)": total_loss,
                    "ë¡œìŠ¤ìœ¨(%)": loss_rate,
                })

            summary_df = pd.DataFrame(display_data)
            st.dataframe(
                summary_df.style.format({
                    "ì´íˆ¬ì…(kg)": "{:,.1f}",
                    "ì´ìƒì‚°(kg)": "{:,.1f}",
                    "ì´ë¡œìŠ¤(kg)": "{:,.1f}",
                    "ë¡œìŠ¤ìœ¨(%)": "{:.1f}",
                }),
                use_container_width=True, hide_index=True
            )

            st.divider()

            # ìƒì„¸ ë³´ê¸°
            for _, upload_row in uploads_df.iterrows():
                uid = int(upload_row["id"])
                u_date = upload_row.get("upload_date", "")
                u_file = upload_row.get("file_name", "")
                u_groups_count = int(upload_row.get("total_groups", 0) or 0)

                with st.expander(f"ğŸ“… {u_date} - {u_file} ({u_groups_count}ê·¸ë£¹)", expanded=False):
                    groups_df = load_production_status_groups(uid)

                    if groups_df.empty:
                        st.info("ê·¸ë£¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                    else:
                        for _, g_row in groups_df.iterrows():
                            gid = int(g_row["id"])
                            g_idx = int(g_row.get("group_index", 0))
                            g_input = float(g_row.get("total_input_kg", 0) or 0)
                            g_output = float(g_row.get("total_output_kg", 0) or 0)
                            g_loss = float(g_row.get("loss_kg", 0) or 0)
                            g_rate = float(g_row.get("loss_rate", 0) or 0)
                            g_in_amt = float(g_row.get("total_input_amount", 0) or 0)
                            g_out_amt = float(g_row.get("total_output_amount", 0) or 0)

                            items_df = load_production_status_items(gid)

                            # ê·¸ë£¹ ë¼ë²¨
                            meat_names = []
                            prod_names = []
                            if not items_df.empty:
                                meats = items_df[items_df["item_type"] == "raw_meat"]
                                prods = items_df[items_df["item_type"] == "product"]
                                meat_names = meats["meat_name"].dropna().astype(str).str.strip().tolist()
                                prod_names = prods["product_name"].dropna().astype(str).str.strip().tolist()
                                meat_names = [n for n in meat_names if n]
                                prod_names = [n for n in prod_names if n]

                            g_label = f"ê·¸ë£¹ {g_idx + 1}: {', '.join(meat_names[:2])} â†’ {', '.join(prod_names[:2])} (ë¡œìŠ¤ {g_rate:.1f}%)"

                            st.markdown(f"**{g_label}**")
                            st.caption(
                                f"íˆ¬ì…: {g_input:,.1f}kg ({g_in_amt:,.0f}ì›) â†’ "
                                f"ìƒì‚°: {g_output:,.1f}kg ({g_out_amt:,.0f}ì›) â†’ "
                                f"ë¡œìŠ¤: {g_loss:,.1f}kg ({g_rate:.1f}%)"
                            )

                            if not items_df.empty:
                                # ì›ìœ¡ í•­ëª©
                                meats = items_df[items_df["item_type"] == "raw_meat"]
                                if not meats.empty:
                                    meat_disp = meats[["meat_code", "meat_name", "meat_origin", "meat_grade",
                                                        "meat_boxes", "meat_kg", "meat_amount"]].copy()
                                    meat_disp.columns = ["ì›ìœ¡ì½”ë“œ", "ì›ìœ¡ëª…", "ì›ì‚°ì§€", "ë“±ê¸‰", "Box", "ì¤‘ëŸ‰(Kg)", "ê¸ˆì•¡"]
                                    st.dataframe(meat_disp, use_container_width=True, hide_index=True)

                                # ìƒí’ˆ í•­ëª©
                                prods = items_df[items_df["item_type"] == "product"]
                                if not prods.empty:
                                    prod_disp = prods[["product_code", "product_name", "product_origin",
                                                        "product_grade", "product_boxes", "product_kg",
                                                        "product_amount"]].copy()
                                    prod_disp.columns = ["ìƒí’ˆì½”ë“œ", "ìƒí’ˆëª…", "ì›ì‚°ì§€", "ë“±ê¸‰", "Box", "ì¤‘ëŸ‰(Kg)", "ê¸ˆì•¡"]
                                    st.dataframe(prod_disp, use_container_width=True, hide_index=True)

                            st.markdown("---")

                    # ì‚­ì œ ë²„íŠ¼
                    if st.button(f"ğŸ—‘ï¸ ì´ ì—…ë¡œë“œ ì‚­ì œ", key=f"del_upload_{uid}"):
                        st.session_state[f"_confirm_del_{uid}"] = True

                    if st.session_state.get(f"_confirm_del_{uid}"):
                        st.warning("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•˜ìœ„ ê·¸ë£¹/í•­ëª©ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.")
                        c1, c2, _ = st.columns([1, 1, 4])
                        with c1:
                            if st.button("âœ… í™•ì¸", key=f"confirm_del_{uid}"):
                                delete_production_status_upload(uid)
                                st.session_state[f"_confirm_del_{uid}"] = False
                                st.session_state["_ps_delete_success"] = "âœ… ì‚­ì œ ì™„ë£Œ!"
                                st.rerun()
                        with c2:
                            if st.button("âŒ ì·¨ì†Œ", key=f"cancel_del_{uid}"):
                                st.session_state[f"_confirm_del_{uid}"] = False
                                st.rerun()


# ========================
# Tab 2: ë¡œìŠ¤ í˜„í™© (ì½ê¸° ì „ìš©)
# ========================

with tab2:
    st.subheader("ğŸ“Š ë¡œìŠ¤ í˜„í™©")
    st.caption("íˆ¬ì…ìƒí’ˆ ê¸°ì¤€ ìƒì‚°í˜„í™© ì—…ë¡œë“œ ë°ì´í„°ì—ì„œ ê³„ì‚°ëœ ë¡œìŠ¤ í˜„í™©ì…ë‹ˆë‹¤.")

    uploads_df = load_production_status_uploads()

    # ê¸°ì¡´ loss_assignments ì´ë ¥ë„ í‘œì‹œ
    legacy_df = load_loss_assignments()
    has_legacy = not legacy_df.empty
    has_new = not uploads_df.empty

    if not has_new and not has_legacy:
        st.info("ë¡œìŠ¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. 'íˆ¬ì…ìƒí’ˆ ê¸°ì¤€ ìƒì‚°í˜„í™©' íƒ­ì—ì„œ ì—‘ì…€ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
    else:
        # â”€â”€ ì‹ ê·œ ë°ì´í„° (production_status) â”€â”€
        if has_new:
            st.markdown("#### ğŸ“‹ ìƒì‚°í˜„í™© ê¸°ë°˜ ë¡œìŠ¤")

            # ì „ì²´ ìš”ì•½
            total_input = uploads_df["total_input_kg"].fillna(0).astype(float).sum()
            total_output = uploads_df["total_output_kg"].fillna(0).astype(float).sum()
            total_loss = uploads_df["total_loss_kg"].fillna(0).astype(float).sum()
            avg_rate = round((total_loss / total_input * 100), 1) if total_input > 0 else 0

            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("ì´ íˆ¬ì…ëŸ‰", f"{total_input:,.1f}kg")
            with col2:
                st.metric("ì´ ìƒì‚°ëŸ‰", f"{total_output:,.1f}kg")
            with col3:
                st.metric("ì´ ë¡œìŠ¤", f"{total_loss:,.1f}kg")
            with col4:
                st.metric("í‰ê·  ë¡œìŠ¤ìœ¨", f"{avg_rate:.1f}%")

            st.divider()

            # ì—…ë¡œë“œë³„ ìš”ì•½
            for _, u_row in uploads_df.iterrows():
                uid = int(u_row["id"])
                u_date = u_row.get("upload_date", "")
                u_input = float(u_row.get("total_input_kg", 0) or 0)
                u_output = float(u_row.get("total_output_kg", 0) or 0)
                u_loss = float(u_row.get("total_loss_kg", 0) or 0)
                u_rate = round((u_loss / u_input * 100), 1) if u_input > 0 else 0

                groups_df = load_production_status_groups(uid)

                st.markdown(
                    f"**ğŸ“… {u_date}** â€” "
                    f"íˆ¬ì… {u_input:,.1f}kg â†’ ìƒì‚° {u_output:,.1f}kg â†’ "
                    f"ë¡œìŠ¤ {u_loss:,.1f}kg ({u_rate:.1f}%)"
                )

                if not groups_df.empty:
                    g_display = []
                    for _, g_row in groups_df.iterrows():
                        gid = int(g_row["id"])
                        items_df = load_production_status_items(gid)

                        meat_names = ""
                        prod_names = ""
                        if not items_df.empty:
                            meats = items_df[items_df["item_type"] == "raw_meat"]["meat_name"].dropna().astype(str).str.strip()
                            prods = items_df[items_df["item_type"] == "product"]["product_name"].dropna().astype(str).str.strip()
                            meat_names = ", ".join([n for n in meats if n][:3])
                            prod_names = ", ".join([n for n in prods if n][:3])

                        g_display.append({
                            "ê·¸ë£¹": int(g_row.get("group_index", 0)) + 1,
                            "ì›ìœ¡": meat_names,
                            "ìƒí’ˆ": prod_names,
                            "íˆ¬ì…(kg)": float(g_row.get("total_input_kg", 0) or 0),
                            "ìƒì‚°(kg)": float(g_row.get("total_output_kg", 0) or 0),
                            "ë¡œìŠ¤(kg)": float(g_row.get("loss_kg", 0) or 0),
                            "ë¡œìŠ¤ìœ¨(%)": float(g_row.get("loss_rate", 0) or 0),
                        })

                    st.dataframe(
                        pd.DataFrame(g_display).style.format({
                            "íˆ¬ì…(kg)": "{:,.1f}",
                            "ìƒì‚°(kg)": "{:,.1f}",
                            "ë¡œìŠ¤(kg)": "{:,.1f}",
                            "ë¡œìŠ¤ìœ¨(%)": "{:.1f}",
                        }),
                        use_container_width=True, hide_index=True
                    )

                st.divider()

        # â”€â”€ ê¸°ì¡´ ë°ì´í„° (loss_assignments) â”€â”€
        if has_legacy:
            completed = legacy_df[
                (legacy_df["completed"] == True) &
                (legacy_df["product_name"].fillna("").astype(str).str.strip() != "")
            ]

            if not completed.empty:
                st.markdown("#### ğŸ“‹ ê¸°ì¡´ ë¡œìŠ¤ í• ë‹¹ ì´ë ¥")
                st.caption("ì´ì „ ë°©ì‹(ìˆ˜ë™ í• ë‹¹)ìœ¼ë¡œ ê¸°ë¡ëœ ë¡œìŠ¤ ë°ì´í„°ì…ë‹ˆë‹¤.")

                summary_data = []
                for _, row in completed.iterrows():
                    kg = float(row.get("kg", 0) or 0)
                    prod_kg = float(row.get("production_kg", 0) or 0)
                    loss_kg = round(kg - prod_kg, 2) if kg > 0 and prod_kg > 0 else 0
                    loss_rate = round(loss_kg / kg * 100, 2) if kg > 0 and prod_kg > 0 else None

                    summary_data.append({
                        "ë‚ ì§œ": row.get("move_date", ""),
                        "ì œí’ˆëª…": row.get("product_name", ""),
                        "ì›ìœ¡ëª…": row.get("meat_name", ""),
                        "íˆ¬ì…(kg)": kg,
                        "ìƒì‚°(kg)": prod_kg,
                        "ë¡œìŠ¤(kg)": loss_kg,
                        "ë¡œìŠ¤ìœ¨(%)": loss_rate,
                    })

                legacy_summary = pd.DataFrame(summary_data)
                st.dataframe(
                    legacy_summary.style.format({
                        "íˆ¬ì…(kg)": "{:,.1f}",
                        "ìƒì‚°(kg)": "{:,.1f}",
                        "ë¡œìŠ¤(kg)": "{:,.1f}",
                        "ë¡œìŠ¤ìœ¨(%)": "{:.1f}",
                    }, na_rep="-"),
                    use_container_width=True, hide_index=True
                )
