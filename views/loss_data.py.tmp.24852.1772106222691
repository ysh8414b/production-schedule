import streamlit as st
import pandas as pd
from views.sales import (
    supabase,
    load_raw_meat_inputs,
    load_loss_assignments,
    insert_loss_assignments_bulk,
    update_loss_assignment,
    delete_loss_assignment,
    sync_product_rawmeats,
)

# ========================
# ë¡œì»¬ DB í•¨ìˆ˜
# ========================

@st.cache_data(ttl=120)
def load_products():
    result = supabase.table("products").select("*").order("product_name").execute()
    if result.data:
        return pd.DataFrame(result.data)
    return pd.DataFrame(columns=["id", "product_code", "product_name", "used_raw_meat", "category"])


# ========================
# í˜ì´ì§€ ë Œë”ë§
# ========================

st.title("ğŸ“‰ ë¡œìŠ¤ ë°ì´í„°")
st.caption("íˆ¬ì… ì›ìœ¡ â†’ ì œí’ˆ í• ë‹¹ â†’ ë¡œìŠ¤ ê´€ë¦¬")

menu = st.radio("ì„ íƒ", [
    "ğŸ“‹ íˆ¬ì… í˜„í™© / ì œí’ˆ í• ë‹¹",
    "ğŸ“¥ ì›ìœ¡ ë¶ˆëŸ¬ì˜¤ê¸°",
], horizontal=True, key="loss_data_menu")

st.divider()

# ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
for msg_key in ["_assign_success", "_edit_success", "_delete_success", "_import_success"]:
    if st.session_state.get(msg_key):
        st.success(st.session_state[msg_key])
        del st.session_state[msg_key]


# ========================
# ì›ìœ¡ ë¶ˆëŸ¬ì˜¤ê¸° (íˆ¬ì… ì›ìœ¡ â†’ ë¡œìŠ¤ í• ë‹¹)
# ========================

if menu == "ğŸ“¥ ì›ìœ¡ ë¶ˆëŸ¬ì˜¤ê¸°":
    st.subheader("ğŸ“¥ íˆ¬ì… ì›ìœ¡ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°")
    st.caption("íŒë§¤ ë°ì´í„° â†’ íˆ¬ì… ì›ìœ¡ì— ë“±ë¡ëœ ë°ì´í„° ì¤‘ ì•„ì§ ë¡œìŠ¤ì— ë¶ˆëŸ¬ì˜¤ì§€ ì•Šì€ ì›ìœ¡ì„ ì„ íƒí•©ë‹ˆë‹¤.")

    raw_df = load_raw_meat_inputs()
    loss_df = load_loss_assignments()

    if raw_df.empty:
        st.info("íˆ¬ì…ëœ ì›ìœ¡ì´ ì—†ìŠµë‹ˆë‹¤. 'íŒë§¤ ë°ì´í„° â†’ íˆ¬ì… ì›ìœ¡' íƒ­ì—ì„œ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
    else:
        # ì´ë¯¸ ë¡œìŠ¤ì— ë¶ˆëŸ¬ì˜¨ raw_meat_input_id ëª©ë¡
        imported_ids = set()
        if not loss_df.empty and "raw_meat_input_id" in loss_df.columns:
            imported_ids = set(loss_df["raw_meat_input_id"].dropna().astype(int).tolist())

        # ì•„ì§ ë¶ˆëŸ¬ì˜¤ì§€ ì•Šì€ ì›ìœ¡ë§Œ í•„í„°
        available = raw_df[~raw_df["id"].isin(imported_ids)].copy()

        if available.empty:
            st.info("ëª¨ë“  íˆ¬ì… ì›ìœ¡ì´ ì´ë¯¸ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.")
        else:
            st.success(f"ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆëŠ” ì›ìœ¡: **{len(available)}ê±´**")

            # ë‚ ì§œ í•„í„°
            all_dates = sorted(available["move_date"].dropna().unique().tolist(), reverse=True)
            sel_dates = st.multiselect(
                "ğŸ“… ë‚ ì§œ í•„í„°",
                options=all_dates,
                default=[all_dates[0]] if all_dates else [],
                placeholder="ì „ì²´ ë‚ ì§œ",
                key="import_date_filter"
            )

            filtered = available.copy()
            if sel_dates:
                filtered = filtered[filtered["move_date"].isin(sel_dates)]

            if filtered.empty:
                st.info("í•´ë‹¹ ë‚ ì§œì— ë¶ˆëŸ¬ì˜¬ ì›ìœ¡ì´ ì—†ìŠµë‹ˆë‹¤.")
            else:
                # ì²´í¬ë°•ìŠ¤ë¡œ ì„ íƒ
                display_data = []
                for _, row in filtered.iterrows():
                    move_amount = row.get("move_amount", 0)
                    if pd.isna(move_amount):
                        move_amount = 0
                    display_data.append({
                        "ì„ íƒ": True,
                        "ì´ë™ì¼ì": row.get("move_date", ""),
                        "ìƒí’ˆì½”ë“œ": str(row.get("meat_code", "")),
                        "ìƒí’ˆëª…": str(row.get("meat_name", "")),
                        "ì›ì‚°ì§€(ë“±ê¸‰)": str(row.get("origin_grade", "")),
                        "Kg": float(row.get("kg", 0) or 0),
                        "ì´ë ¥ë²ˆí˜¸": str(row.get("tracking_number", "")),
                        "_raw_id": row["id"],
                    })

                select_df = pd.DataFrame(display_data)

                edited = st.data_editor(
                    select_df[["ì„ íƒ", "ì´ë™ì¼ì", "ìƒí’ˆì½”ë“œ", "ìƒí’ˆëª…", "ì›ì‚°ì§€(ë“±ê¸‰)", "Kg", "ì´ë ¥ë²ˆí˜¸"]],
                    use_container_width=True,
                    hide_index=True,
                    key="import_select_editor",
                    disabled=["ì´ë™ì¼ì", "ìƒí’ˆì½”ë“œ", "ìƒí’ˆëª…", "ì›ì‚°ì§€(ë“±ê¸‰)", "Kg", "ì´ë ¥ë²ˆí˜¸"],
                    column_config={
                        "ì„ íƒ": st.column_config.CheckboxColumn("ì„ íƒ", default=True),
                    }
                )

                selected_mask = edited["ì„ íƒ"] == True
                selected_count = selected_mask.sum()

                st.caption(f"ì„ íƒ: **{selected_count}ê±´** / ì „ì²´: {len(filtered)}ê±´")

                if selected_count > 0:
                    if st.button("ğŸ“¥ ì„ íƒ ì›ìœ¡ ë¶ˆëŸ¬ì˜¤ê¸°", type="primary", use_container_width=True, key="import_confirm"):
                        rows_to_insert = []
                        for idx in edited[selected_mask].index:
                            raw_row = display_data[idx]
                            rows_to_insert.append({
                                "raw_meat_input_id": raw_row["_raw_id"],
                                "move_date": raw_row["ì´ë™ì¼ì"],
                                "meat_code": raw_row["ìƒí’ˆì½”ë“œ"],
                                "meat_name": raw_row["ìƒí’ˆëª…"],
                                "origin_grade": raw_row["ì›ì‚°ì§€(ë“±ê¸‰)"],
                                "kg": raw_row["Kg"],
                                "tracking_number": raw_row["ì´ë ¥ë²ˆí˜¸"],
                                "product_name": "",
                                "production_kg": 0.0,
                                "memo": "",
                                "completed": False,
                            })
                        try:
                            insert_loss_assignments_bulk(rows_to_insert)
                            st.session_state["_import_success"] = f"âœ… {len(rows_to_insert)}ê±´ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!"
                            st.rerun()
                        except Exception as e:
                            st.error(f"âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: {str(e)}")


# ========================
# íˆ¬ì… í˜„í™© / ì œí’ˆ í• ë‹¹
# ========================

elif menu == "ğŸ“‹ íˆ¬ì… í˜„í™© / ì œí’ˆ í• ë‹¹":
    st.subheader("ğŸ“‹ íˆ¬ì… í˜„í™© / ì œí’ˆ í• ë‹¹")

    df = load_loss_assignments()

    if df.empty:
        st.info("ë¶ˆëŸ¬ì˜¨ ì›ìœ¡ì´ ì—†ìŠµë‹ˆë‹¤. 'ì›ìœ¡ ë¶ˆëŸ¬ì˜¤ê¸°'ì—ì„œ íˆ¬ì… ì›ìœ¡ì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.")
    else:
        products_df = load_products()
        product_options = []
        if not products_df.empty:
            product_options = products_df.apply(
                lambda r: f"{r['product_code']} | {r['product_name']}", axis=1
            ).tolist()

        # ë¯¸í• ë‹¹ê±´ (ì œí’ˆ ë¯¸ì§€ì •)
        unassigned = df[
            (df["product_name"].fillna("").astype(str).str.strip() == "") |
            (df["completed"] == False)
        ].copy()

        assigned = df[
            (df["product_name"].fillna("").astype(str).str.strip() != "") &
            (df["completed"] == True)
        ].copy()

        # â”€â”€ ë¯¸í• ë‹¹ê±´ (ì´ë™ì¼ìë³„)
        if not unassigned.empty:
            st.markdown(f"#### âš ï¸ ë¯¸í• ë‹¹ ê±´ ({len(unassigned)}ê±´)")

            dates = sorted(unassigned["move_date"].dropna().unique().tolist(), reverse=True)

            for move_date_val in dates:
                date_rows = unassigned[unassigned["move_date"] == move_date_val]
                st.markdown(f"**ğŸ“… {move_date_val}** ({len(date_rows)}ê±´)")

                for _, row in date_rows.iterrows():
                    rid = int(row["id"])
                    meat_name = str(row.get("meat_name", "")).strip()
                    meat_code = str(row.get("meat_code", "")).strip()
                    origin = str(row.get("origin_grade", "")).strip()
                    tracking = str(row.get("tracking_number", "")).strip()
                    kg = float(row.get("kg", 0) or 0)
                    current_product = str(row.get("product_name", "")).strip()

                    if current_product:
                        label = f"ğŸ”¹ {current_product}"
                    else:
                        label = f"ğŸ”¸ {meat_name}"
                    if origin:
                        label += f" ({origin})"
                    label += f" | {kg}kg"

                    with st.expander(label, expanded=False):
                        # ì½ê¸° ì „ìš© ì›ìœ¡ ì •ë³´
                        info_col1, info_col2 = st.columns(2)
                        with info_col1:
                            st.text_input("ì›ìœ¡ëª…", value=meat_name, disabled=True, key=f"ro_meat_{rid}")
                            st.text_input("ì´ë ¥ë²ˆí˜¸", value=tracking, disabled=True, key=f"ro_track_{rid}")
                        with info_col2:
                            st.text_input("ì›ì‚°ì§€(ë“±ê¸‰)", value=origin, disabled=True, key=f"ro_origin_{rid}")
                            st.text_input("íˆ¬ì…ëŸ‰(kg)", value=f"{kg}", disabled=True, key=f"ro_kg_{rid}")

                        st.divider()

                        # ë¡œìŠ¤ìœ¨ ë¯¸ë¦¬ë³´ê¸° (ì €ì¥ëœ ê°’ ê¸°ì¤€)
                        saved_prod_kg = float(row.get("production_kg", 0) or 0)
                        if kg > 0 and saved_prod_kg > 0:
                            loss_kg = kg - saved_prod_kg
                            loss_rate = round(loss_kg / kg * 100, 2)
                            if loss_rate >= 0:
                                st.info(f"ğŸ“Š ë¡œìŠ¤ìœ¨: **{loss_rate}%** | ë¡œìŠ¤: **{round(loss_kg, 2)}kg** (íˆ¬ì… {kg}kg â†’ ìƒì‚° {saved_prod_kg}kg)")
                            else:
                                st.warning(f"âš ï¸ ìƒì‚°ëŸ‰ì´ íˆ¬ì…ëŸ‰ë³´ë‹¤ í½ë‹ˆë‹¤ (ë¡œìŠ¤ìœ¨: {loss_rate}%)")

                        with st.form(key=f"assign_form_{rid}"):
                            # ì œí’ˆ ì„ íƒ
                            if product_options:
                                current_idx = None
                                if current_product:
                                    for i, opt in enumerate(product_options):
                                        if current_product in opt:
                                            current_idx = i
                                            break
                                sel_product = st.selectbox(
                                    "ìƒì‚°í•  ì œí’ˆ",
                                    options=product_options,
                                    index=current_idx,
                                    placeholder="ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”...",
                                    key=f"assign_product_{rid}"
                                )
                            else:
                                sel_product = st.text_input("ìƒì‚°í•  ì œí’ˆ", value=current_product, key=f"assign_product_{rid}")

                            col_a, col_b = st.columns(2)
                            with col_a:
                                prod_kg = st.number_input(
                                    "ìƒì‚°ëŸ‰(kg)", min_value=0.0,
                                    value=float(row.get("production_kg", 0) or 0),
                                    step=0.1, format="%.1f", key=f"assign_kg_{rid}"
                                )
                            with col_b:
                                memo = st.text_input(
                                    "ë©”ëª¨",
                                    value=str(row.get("memo", "")).strip(),
                                    key=f"assign_memo_{rid}"
                                )

                            # ì €ì¥ / ì‚­ì œ ë²„íŠ¼
                            btn_col1, btn_col2 = st.columns([3, 1])
                            with btn_col1:
                                save_clicked = st.form_submit_button("ğŸ’¾ ì €ì¥", type="primary", use_container_width=True)
                            with btn_col2:
                                del_clicked = st.form_submit_button("ğŸ—‘ï¸ ì‚­ì œ")

                        if save_clicked:
                            try:
                                if sel_product and isinstance(sel_product, str) and " | " in sel_product:
                                    p_name = sel_product.split(" | ", 1)[1].strip()
                                elif sel_product:
                                    p_name = str(sel_product).strip()
                                else:
                                    p_name = ""

                                if not p_name:
                                    st.warning("âš ï¸ ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
                                else:
                                    update_data = {
                                        "product_name": p_name,
                                        "production_kg": float(prod_kg),
                                        "memo": memo.strip() if memo else "",
                                        "completed": True if prod_kg > 0 else False,
                                    }
                                    update_loss_assignment(rid, update_data)
                                    sync_product_rawmeats()

                                    st.session_state["_assign_success"] = f"âœ… '{p_name}' ì €ì¥ ì™„ë£Œ! (id={rid})"
                                    st.rerun()
                            except Exception as e:
                                st.error(f"âŒ ì €ì¥ ì‹¤íŒ¨: {str(e)}")

                        if del_clicked:
                            try:
                                delete_loss_assignment(rid)
                                sync_product_rawmeats()
                                st.session_state["_delete_success"] = "âœ… ì‚­ì œ ì™„ë£Œ (íˆ¬ì… ì›ìœ¡ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)"
                                st.rerun()
                            except Exception as e:
                                st.error(f"âŒ ì‚­ì œ ì‹¤íŒ¨: {str(e)}")

            st.divider()

        # â”€â”€ í• ë‹¹ ì™„ë£Œê±´
        if not assigned.empty:
            st.markdown(f"#### âœ… í• ë‹¹ ì™„ë£Œ ê±´ ({len(assigned)}ê±´)")

            # â”€â”€ í•„í„° ì˜ì—­
            filter_col1, filter_col2, filter_col3 = st.columns(3)

            all_dates = sorted(assigned["move_date"].dropna().unique().tolist(), reverse=True)
            all_products = sorted(assigned["product_name"].fillna("").astype(str).str.strip().unique().tolist())
            all_products = [p for p in all_products if p]
            all_meats = sorted(assigned["meat_name"].fillna("").astype(str).str.strip().unique().tolist())
            all_meats = [m for m in all_meats if m]

            with filter_col1:
                sel_dates = st.multiselect(
                    "ğŸ“… ë‚ ì§œ í•„í„°",
                    options=all_dates,
                    default=[all_dates[0]] if all_dates else [],
                    placeholder="ì „ì²´ ë‚ ì§œ",
                    key="filter_assigned_dates"
                )
            with filter_col2:
                sel_products_filter = st.multiselect(
                    "ğŸ“¦ ì œí’ˆ í•„í„°",
                    options=all_products,
                    default=[],
                    placeholder="ì „ì²´ ì œí’ˆ",
                    key="filter_assigned_products"
                )
            with filter_col3:
                sel_meats_filter = st.multiselect(
                    "ğŸ¥© ì›ìœ¡ í•„í„°",
                    options=all_meats,
                    default=[],
                    placeholder="ì „ì²´ ì›ìœ¡",
                    key="filter_assigned_meats"
                )

            # í•„í„° ì ìš©
            filtered_assigned = assigned.copy()
            if sel_dates:
                filtered_assigned = filtered_assigned[filtered_assigned["move_date"].isin(sel_dates)]
            if sel_products_filter:
                filtered_assigned = filtered_assigned[
                    filtered_assigned["product_name"].fillna("").astype(str).str.strip().isin(sel_products_filter)
                ]
            if sel_meats_filter:
                filtered_assigned = filtered_assigned[
                    filtered_assigned["meat_name"].fillna("").astype(str).str.strip().isin(sel_meats_filter)
                ]

            active_filters = []
            if sel_dates:
                active_filters.append(f"ë‚ ì§œ {len(sel_dates)}ê°œ")
            if sel_products_filter:
                active_filters.append(f"ì œí’ˆ {len(sel_products_filter)}ê°œ")
            if sel_meats_filter:
                active_filters.append(f"ì›ìœ¡ {len(sel_meats_filter)}ê°œ")

            if active_filters:
                st.caption(f"ğŸ” í•„í„° ì ìš©: {', '.join(active_filters)} â†’ **{len(filtered_assigned)}ê±´** í‘œì‹œ")
            else:
                st.caption(f"ì „ì²´ **{len(filtered_assigned)}ê±´** í‘œì‹œ")

            if filtered_assigned.empty:
                st.info("í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                # ë‚ ì§œë³„ ê·¸ë£¹í•‘
                a_dates = sorted(filtered_assigned["move_date"].dropna().unique().tolist(), reverse=True)

                for move_date_val in a_dates:
                    date_rows = filtered_assigned[filtered_assigned["move_date"] == move_date_val]
                    st.markdown(f"**ğŸ“… {move_date_val}** ({len(date_rows)}ê±´)")

                    # ìš”ì•½ í…Œì´ë¸”
                    summary_data = []
                    for _, row in date_rows.iterrows():
                        kg = float(row.get("kg", 0) or 0)
                        prod_kg = float(row.get("production_kg", 0) or 0)
                        loss_kg = round(kg - prod_kg, 2) if kg > 0 and prod_kg > 0 else 0
                        loss_rate = round(loss_kg / kg * 100, 2) if kg > 0 and prod_kg > 0 else None
                        summary_data.append({
                            "ì œí’ˆëª…": row.get("product_name", ""),
                            "ì›ìœ¡ëª…": row.get("meat_name", ""),
                            "ì›ì‚°ì§€(ë“±ê¸‰)": row.get("origin_grade", ""),
                            "ì´ë ¥ë²ˆí˜¸": row.get("tracking_number", ""),
                            "íˆ¬ì…(kg)": kg,
                            "ìƒì‚°(kg)": prod_kg,
                            "ë¡œìŠ¤(kg)": loss_kg,
                            "ë¡œìŠ¤ìœ¨(%)": loss_rate,
                            "ë©”ëª¨": row.get("memo", ""),
                        })

                    summary_df = pd.DataFrame(summary_data)
                    st.dataframe(
                        summary_df.style.format({
                            "íˆ¬ì…(kg)": "{:,.1f}",
                            "ìƒì‚°(kg)": "{:,.1f}",
                            "ë¡œìŠ¤(kg)": "{:,.1f}",
                            "ë¡œìŠ¤ìœ¨(%)": "{:.1f}",
                        }, na_rep="-"),
                        use_container_width=True, hide_index=True
                    )

                    # ìˆ˜ì •ìš© expander
                    for _, row in date_rows.iterrows():
                        rid = int(row["id"])
                        p_name = str(row.get("product_name", "")).strip()
                        meat_name = str(row.get("meat_name", "")).strip()
                        meat_code = str(row.get("meat_code", "")).strip()
                        origin = str(row.get("origin_grade", "")).strip()
                        tracking = str(row.get("tracking_number", "")).strip()
                        kg = float(row.get("kg", 0) or 0)

                        with st.expander(f"âœï¸ {p_name} (ì›ìœ¡: {meat_name})", expanded=False):
                            # ì½ê¸° ì „ìš© ì›ìœ¡ ì •ë³´
                            e_col1, e_col2 = st.columns(2)
                            with e_col1:
                                st.text_input("ì›ìœ¡ëª…", value=meat_name, disabled=True, key=f"ed_meat_{rid}")
                                st.text_input("ì´ë ¥ë²ˆí˜¸", value=tracking, disabled=True, key=f"ed_track_{rid}")
                            with e_col2:
                                st.text_input("ì›ì‚°ì§€(ë“±ê¸‰)", value=origin, disabled=True, key=f"ed_origin_{rid}")
                                st.text_input("íˆ¬ì…ëŸ‰(kg)", value=f"{kg}", disabled=True, key=f"ed_kg_{rid}")

                            st.divider()

                            # ë¡œìŠ¤ìœ¨ ë¯¸ë¦¬ë³´ê¸° (ì €ì¥ëœ ê°’ ê¸°ì¤€)
                            saved_edit_kg = float(row.get("production_kg", 0) or 0)
                            if kg > 0 and saved_edit_kg > 0:
                                loss_kg = kg - saved_edit_kg
                                loss_rate = round(loss_kg / kg * 100, 2)
                                if loss_rate >= 0:
                                    st.info(f"ğŸ“Š ë¡œìŠ¤ìœ¨: **{loss_rate}%** | ë¡œìŠ¤: **{round(loss_kg, 2)}kg** (íˆ¬ì… {kg}kg â†’ ìƒì‚° {saved_edit_kg}kg)")
                                else:
                                    st.warning(f"âš ï¸ ìƒì‚°ëŸ‰ì´ íˆ¬ì…ëŸ‰ë³´ë‹¤ í½ë‹ˆë‹¤ (ë¡œìŠ¤ìœ¨: {loss_rate}%)")

                            with st.form(key=f"edit_form_{rid}"):
                                if product_options:
                                    current_idx = None
                                    for i, opt in enumerate(product_options):
                                        if p_name in opt:
                                            current_idx = i
                                            break
                                    edit_product = st.selectbox(
                                        "ìƒì‚°í•  ì œí’ˆ",
                                        options=product_options,
                                        index=current_idx,
                                        key=f"edit_product_{rid}"
                                    )
                                else:
                                    edit_product = st.text_input("ìƒì‚°í•  ì œí’ˆ", value=p_name, key=f"edit_product_{rid}")

                                e_col_a, e_col_b = st.columns(2)
                                with e_col_a:
                                    edit_prod_kg = st.number_input(
                                        "ìƒì‚°ëŸ‰(kg)", min_value=0.0,
                                        value=float(row.get("production_kg", 0) or 0),
                                        step=0.1, format="%.1f", key=f"edit_kg_{rid}"
                                    )
                                with e_col_b:
                                    edit_memo = st.text_input(
                                        "ë©”ëª¨",
                                        value=str(row.get("memo", "")).strip(),
                                        key=f"edit_memo_{rid}"
                                    )

                                # ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼
                                btn_col1, btn_col2 = st.columns([3, 1])
                                with btn_col1:
                                    edit_save_clicked = st.form_submit_button("ğŸ’¾ ìˆ˜ì • ì €ì¥", type="primary", use_container_width=True)
                                with btn_col2:
                                    edit_del_clicked = st.form_submit_button("ğŸ—‘ï¸ ì‚­ì œ")

                            if edit_save_clicked:
                                try:
                                    if edit_product and isinstance(edit_product, str) and " | " in edit_product:
                                        new_p_name = edit_product.split(" | ", 1)[1].strip()
                                    elif edit_product:
                                        new_p_name = str(edit_product).strip()
                                    else:
                                        new_p_name = ""

                                    update_data = {
                                        "product_name": new_p_name,
                                        "production_kg": float(edit_prod_kg),
                                        "memo": edit_memo.strip() if edit_memo else "",
                                        "completed": True if (new_p_name and edit_prod_kg > 0) else False,
                                    }
                                    update_loss_assignment(rid, update_data)
                                    sync_product_rawmeats()

                                    st.session_state["_edit_success"] = f"âœ… '{new_p_name}' ìˆ˜ì • ì™„ë£Œ!"
                                    st.rerun()
                                except Exception as e:
                                    st.error(f"âŒ ìˆ˜ì • ì‹¤íŒ¨: {str(e)}")

                            if edit_del_clicked:
                                try:
                                    delete_loss_assignment(rid)
                                    sync_product_rawmeats()
                                    st.session_state["_delete_success"] = "âœ… ì‚­ì œ ì™„ë£Œ (íˆ¬ì… ì›ìœ¡ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)"
                                    st.rerun()
                                except Exception as e:
                                    st.error(f"âŒ ì‚­ì œ ì‹¤íŒ¨: {str(e)}")

                    st.divider()

        # â”€â”€ ì „ì²´ ìš”ì•½ ë©”íŠ¸ë¦­
        if not df.empty:
            st.markdown("#### ğŸ“Š ì „ì²´ ìš”ì•½")
            total = len(df)
            completed_count = len(assigned) if not assigned.empty else 0
            pending_count = len(unassigned) if not unassigned.empty else 0

            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("ì „ì²´ ê±´ìˆ˜", f"{total}ê±´")
            with col2:
                st.metric("í• ë‹¹ ì™„ë£Œ", f"{completed_count}ê±´")
            with col3:
                st.metric("ë¯¸í• ë‹¹", f"{pending_count}ê±´")
            with col4:
                total_kg = df["kg"].fillna(0).astype(float).sum()
                st.metric("ì´ íˆ¬ì…ëŸ‰", f"{total_kg:,.1f}kg")
