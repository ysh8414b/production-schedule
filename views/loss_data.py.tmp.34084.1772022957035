import streamlit as st
import pandas as pd
from views.sales import (
    supabase,
    load_raw_meat_inputs,
    update_raw_meat_input,
    delete_raw_meat_input,
    upsert_product_rawmeat,
)

# ========================
# ë¡œì»¬ DB í•¨ìˆ˜
# ========================

@st.cache_data(ttl=120)
def load_products():
    result = supabase.table("products").select("*").order("product_name").execute()
    if result.data:
        return pd.DataFrame(result.data)
    return pd.DataFrame(columns=["id", "product_code", "product_name", "used_raw_meat", "category"])


# ========================
# í˜ì´ì§€ ë Œë”ë§
# ========================

st.title("ğŸ“‰ ë¡œìŠ¤ ë°ì´í„°")
st.caption("íˆ¬ì… ì›ìœ¡ â†’ ì œí’ˆ í• ë‹¹ â†’ ë¡œìŠ¤ ê´€ë¦¬")

st.subheader("ğŸ“‹ íˆ¬ì… í˜„í™© / ì œí’ˆ í• ë‹¹")

# ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
for msg_key in ["_assign_success", "_edit_success", "_delete_success"]:
    if st.session_state.get(msg_key):
        st.success(st.session_state[msg_key])
        del st.session_state[msg_key]

df = load_raw_meat_inputs()

if df.empty:
    st.info("íˆ¬ì…ëœ ì›ìœ¡ì´ ì—†ìŠµë‹ˆë‹¤. 'íŒë§¤ ë°ì´í„° â†’ íˆ¬ì… ì›ìœ¡' íƒ­ì—ì„œ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
else:
    products_df = load_products()
    product_options = []
    if not products_df.empty:
        product_options = products_df.apply(
            lambda r: f"{r['product_code']} | {r['product_name']}", axis=1
        ).tolist()

    # ë¯¸í• ë‹¹ê±´ (ì œí’ˆ ë¯¸ì§€ì •)
    unassigned = df[
        (df["product_name"].fillna("").astype(str).str.strip() == "") |
        (df["completed"] == False)
    ].copy()

    assigned = df[
        (df["product_name"].fillna("").astype(str).str.strip() != "") &
        (df["completed"] == True)
    ].copy()

    # â”€â”€ ë¯¸í• ë‹¹ê±´ (ì´ë™ì¼ìë³„)
    if not unassigned.empty:
        st.markdown(f"#### âš ï¸ ë¯¸í• ë‹¹ ê±´ ({len(unassigned)}ê±´)")

        # ì´ë™ì¼ìë³„ ê·¸ë£¹í•‘
        dates = sorted(unassigned["move_date"].dropna().unique().tolist(), reverse=True)

        for move_date_val in dates:
            date_rows = unassigned[unassigned["move_date"] == move_date_val]
            st.markdown(f"**ğŸ“… {move_date_val}** ({len(date_rows)}ê±´)")

            for _, row in date_rows.iterrows():
                rid = row["id"]
                meat_name = str(row.get("meat_name", "")).strip()
                meat_code = str(row.get("meat_code", "")).strip()
                origin = str(row.get("origin_grade", "")).strip()
                tracking = str(row.get("tracking_number", "")).strip()
                kg = float(row.get("kg", 0) or 0)
                current_product = str(row.get("product_name", "")).strip()

                # ì œí’ˆì´ í• ë‹¹ë˜ì–´ ìˆìœ¼ë©´ ì œí’ˆëª…ì„, ì•„ë‹ˆë©´ ì›ìœ¡ëª… í‘œì‹œ
                if current_product:
                    label = f"ğŸ”¹ {current_product}"
                else:
                    label = f"ğŸ”¸ {meat_name}"
                if origin:
                    label += f" ({origin})"
                label += f" | {kg}kg"

                with st.expander(label, expanded=False):
                    # ì½ê¸° ì „ìš© ì›ìœ¡ ì •ë³´
                    info_col1, info_col2 = st.columns(2)
                    with info_col1:
                        st.text_input("ì›ìœ¡ëª…", value=meat_name, disabled=True, key=f"ro_meat_{rid}")
                        st.text_input("ì´ë ¥ë²ˆí˜¸", value=tracking, disabled=True, key=f"ro_track_{rid}")
                    with info_col2:
                        st.text_input("ì›ì‚°ì§€(ë“±ê¸‰)", value=origin, disabled=True, key=f"ro_origin_{rid}")
                        st.text_input("íˆ¬ì…ëŸ‰(kg)", value=f"{kg}", disabled=True, key=f"ro_kg_{rid}")

                    st.divider()

                    # ì œí’ˆ í• ë‹¹ ì…ë ¥
                    if product_options:
                        current_idx = None
                        if current_product:
                            for i, opt in enumerate(product_options):
                                if current_product in opt:
                                    current_idx = i
                                    break
                        sel_product = st.selectbox(
                            "ìƒì‚°í•  ì œí’ˆ",
                            options=product_options,
                            index=current_idx,
                            placeholder="ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”...",
                            key=f"assign_product_{rid}"
                        )
                    else:
                        sel_product = st.text_input("ìƒì‚°í•  ì œí’ˆ", value=current_product, key=f"assign_product_{rid}")

                    col_a, col_b = st.columns(2)
                    with col_a:
                        prod_kg = st.number_input(
                            "ìƒì‚°ëŸ‰(kg)", min_value=0.0,
                            value=float(row.get("production_kg", 0) or 0),
                            step=0.1, format="%.1f", key=f"assign_kg_{rid}"
                        )
                    with col_b:
                        memo = st.text_input(
                            "ë©”ëª¨",
                            value=str(row.get("memo", "")).strip(),
                            key=f"assign_memo_{rid}"
                        )

                    # ë¡œìŠ¤ìœ¨ ë¯¸ë¦¬ë³´ê¸°
                    if kg > 0 and prod_kg > 0:
                        loss_kg = kg - prod_kg
                        loss_rate = round(loss_kg / kg * 100, 2)
                        if loss_rate >= 0:
                            st.info(f"ğŸ“Š ë¡œìŠ¤ìœ¨: **{loss_rate}%** | ë¡œìŠ¤: **{round(loss_kg, 2)}kg**")
                        else:
                            st.warning(f"âš ï¸ ìƒì‚°ëŸ‰ì´ íˆ¬ì…ëŸ‰ë³´ë‹¤ í½ë‹ˆë‹¤ (ë¡œìŠ¤ìœ¨: {loss_rate}%)")

                    submitted = st.button("ğŸ’¾ ì €ì¥", type="primary", use_container_width=True, key=f"assign_save_{rid}")

                    # ì €ì¥ ì²˜ë¦¬
                    if submitted:
                        try:
                            # ì œí’ˆëª… ì¶”ì¶œ
                            if sel_product and isinstance(sel_product, str) and " | " in sel_product:
                                p_name = sel_product.split(" | ", 1)[1].strip()
                            elif sel_product:
                                p_name = str(sel_product).strip()
                            else:
                                p_name = ""

                            update_data = {
                                "product_name": p_name,
                                "production_kg": float(prod_kg),
                                "memo": memo.strip() if memo else "",
                                "completed": True if (p_name and prod_kg > 0) else False,
                            }
                            update_raw_meat_input(rid, update_data)

                            # ì œí’ˆ-ì›ìœ¡ ë§¤í•‘ ìë™ ë“±ë¡
                            if p_name and meat_code:
                                upsert_product_rawmeat(p_name, meat_code, meat_name, origin)

                            st.session_state["_assign_success"] = f"âœ… '{p_name or meat_name}' ì €ì¥ ì™„ë£Œ!"
                            st.rerun()
                        except Exception as e:
                            st.error(f"âŒ ì €ì¥ ì‹¤íŒ¨: {str(e)}")

                    # í• ë‹¹ ì´ˆê¸°í™” ë²„íŠ¼ (íˆ¬ì… ì›ìœ¡ ë°ì´í„°ëŠ” ìœ ì§€)
                    if current_product:
                        if st.button("ğŸ”„ í• ë‹¹ í•´ì œ", key=f"assign_reset_{rid}", use_container_width=False):
                            try:
                                update_raw_meat_input(rid, {
                                    "product_name": "",
                                    "production_kg": 0.0,
                                    "memo": "",
                                    "completed": False,
                                })
                                st.session_state["_delete_success"] = "âœ… í• ë‹¹ í•´ì œ ì™„ë£Œ"
                                st.rerun()
                            except Exception as e:
                                st.error(f"âŒ í• ë‹¹ í•´ì œ ì‹¤íŒ¨: {str(e)}")

        st.divider()

    # â”€â”€ í• ë‹¹ ì™„ë£Œê±´
    if not assigned.empty:
        st.markdown(f"#### âœ… í• ë‹¹ ì™„ë£Œ ê±´ ({len(assigned)}ê±´)")

        # â”€â”€ í•„í„° ì˜ì—­
        filter_col1, filter_col2, filter_col3 = st.columns(3)

        all_dates = sorted(assigned["move_date"].dropna().unique().tolist(), reverse=True)
        all_products = sorted(assigned["product_name"].fillna("").astype(str).str.strip().unique().tolist())
        all_products = [p for p in all_products if p]
        all_meats = sorted(assigned["meat_name"].fillna("").astype(str).str.strip().unique().tolist())
        all_meats = [m for m in all_meats if m]

        with filter_col1:
            sel_dates = st.multiselect(
                "ğŸ“… ë‚ ì§œ í•„í„°",
                options=all_dates,
                default=[all_dates[0]] if all_dates else [],
                placeholder="ì „ì²´ ë‚ ì§œ",
                key="filter_assigned_dates"
            )
        with filter_col2:
            sel_products_filter = st.multiselect(
                "ğŸ“¦ ì œí’ˆ í•„í„°",
                options=all_products,
                default=[],
                placeholder="ì „ì²´ ì œí’ˆ",
                key="filter_assigned_products"
            )
        with filter_col3:
            sel_meats_filter = st.multiselect(
                "ğŸ¥© ì›ìœ¡ í•„í„°",
                options=all_meats,
                default=[],
                placeholder="ì „ì²´ ì›ìœ¡",
                key="filter_assigned_meats"
            )

        # í•„í„° ì ìš©
        filtered_assigned = assigned.copy()
        if sel_dates:
            filtered_assigned = filtered_assigned[filtered_assigned["move_date"].isin(sel_dates)]
        if sel_products_filter:
            filtered_assigned = filtered_assigned[
                filtered_assigned["product_name"].fillna("").astype(str).str.strip().isin(sel_products_filter)
            ]
        if sel_meats_filter:
            filtered_assigned = filtered_assigned[
                filtered_assigned["meat_name"].fillna("").astype(str).str.strip().isin(sel_meats_filter)
            ]

        active_filters = []
        if sel_dates:
            active_filters.append(f"ë‚ ì§œ {len(sel_dates)}ê°œ")
        if sel_products_filter:
            active_filters.append(f"ì œí’ˆ {len(sel_products_filter)}ê°œ")
        if sel_meats_filter:
            active_filters.append(f"ì›ìœ¡ {len(sel_meats_filter)}ê°œ")

        if active_filters:
            st.caption(f"ğŸ” í•„í„° ì ìš©: {', '.join(active_filters)} â†’ **{len(filtered_assigned)}ê±´** í‘œì‹œ")
        else:
            st.caption(f"ì „ì²´ **{len(filtered_assigned)}ê±´** í‘œì‹œ")

        if filtered_assigned.empty:
            st.info("í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            # ë‚ ì§œë³„ ê·¸ë£¹í•‘
            a_dates = sorted(filtered_assigned["move_date"].dropna().unique().tolist(), reverse=True)

            for move_date_val in a_dates:
                date_rows = filtered_assigned[filtered_assigned["move_date"] == move_date_val]
                st.markdown(f"**ğŸ“… {move_date_val}** ({len(date_rows)}ê±´)")

                # ìš”ì•½ í…Œì´ë¸”
                summary_data = []
                for _, row in date_rows.iterrows():
                    kg = float(row.get("kg", 0) or 0)
                    prod_kg = float(row.get("production_kg", 0) or 0)
                    loss_kg = round(kg - prod_kg, 2) if kg > 0 and prod_kg > 0 else 0
                    loss_rate = round(loss_kg / kg * 100, 2) if kg > 0 and prod_kg > 0 else None
                    summary_data.append({
                        "ì œí’ˆëª…": row.get("product_name", ""),
                        "ì›ìœ¡ëª…": row.get("meat_name", ""),
                        "ì›ì‚°ì§€(ë“±ê¸‰)": row.get("origin_grade", ""),
                        "ì´ë ¥ë²ˆí˜¸": row.get("tracking_number", ""),
                        "íˆ¬ì…(kg)": kg,
                        "ìƒì‚°(kg)": prod_kg,
                        "ë¡œìŠ¤(kg)": loss_kg,
                        "ë¡œìŠ¤ìœ¨(%)": loss_rate,
                        "ë©”ëª¨": row.get("memo", ""),
                    })

                summary_df = pd.DataFrame(summary_data)
                st.dataframe(
                    summary_df.style.format({
                        "íˆ¬ì…(kg)": "{:,.1f}",
                        "ìƒì‚°(kg)": "{:,.1f}",
                        "ë¡œìŠ¤(kg)": "{:,.1f}",
                        "ë¡œìŠ¤ìœ¨(%)": "{:.1f}",
                    }, na_rep="-"),
                    use_container_width=True, hide_index=True
                )

                # ìˆ˜ì •ìš© expander
                for _, row in date_rows.iterrows():
                    rid = row["id"]
                    p_name = str(row.get("product_name", "")).strip()
                    meat_name = str(row.get("meat_name", "")).strip()
                    meat_code = str(row.get("meat_code", "")).strip()
                    origin = str(row.get("origin_grade", "")).strip()
                    tracking = str(row.get("tracking_number", "")).strip()
                    kg = float(row.get("kg", 0) or 0)

                    with st.expander(f"âœï¸ {p_name} (ì›ìœ¡: {meat_name})", expanded=False):
                        # ì½ê¸° ì „ìš© ì›ìœ¡ ì •ë³´
                        e_col1, e_col2 = st.columns(2)
                        with e_col1:
                            st.text_input("ì›ìœ¡ëª…", value=meat_name, disabled=True, key=f"ed_meat_{rid}")
                            st.text_input("ì´ë ¥ë²ˆí˜¸", value=tracking, disabled=True, key=f"ed_track_{rid}")
                        with e_col2:
                            st.text_input("ì›ì‚°ì§€(ë“±ê¸‰)", value=origin, disabled=True, key=f"ed_origin_{rid}")
                            st.text_input("íˆ¬ì…ëŸ‰(kg)", value=f"{kg}", disabled=True, key=f"ed_kg_{rid}")

                        st.divider()

                        # st.formìœ¼ë¡œ ê°ì‹¸ì„œ ì…ë ¥ ì¤‘ rerun ë°©ì§€
                        with st.form(key=f"edit_form_{rid}"):
                            # ìˆ˜ì • ê°€ëŠ¥ í•„ë“œ
                            if product_options:
                                current_idx = None
                                for i, opt in enumerate(product_options):
                                    if p_name in opt:
                                        current_idx = i
                                        break
                                edit_product = st.selectbox(
                                    "ìƒì‚°í•  ì œí’ˆ",
                                    options=product_options,
                                    index=current_idx,
                                    key=f"edit_product_{rid}"
                                )
                            else:
                                edit_product = st.text_input("ìƒì‚°í•  ì œí’ˆ", value=p_name, key=f"edit_product_{rid}")

                            e_col_a, e_col_b = st.columns(2)
                            with e_col_a:
                                edit_prod_kg = st.number_input(
                                    "ìƒì‚°ëŸ‰(kg)", min_value=0.0,
                                    value=float(row.get("production_kg", 0) or 0),
                                    step=0.1, format="%.1f", key=f"edit_kg_{rid}"
                                )
                            with e_col_b:
                                edit_memo = st.text_input(
                                    "ë©”ëª¨",
                                    value=str(row.get("memo", "")).strip(),
                                    key=f"edit_memo_{rid}"
                                )

                            edit_submitted = st.form_submit_button("ğŸ’¾ ìˆ˜ì • ì €ì¥", type="primary", use_container_width=True)

                        # ë¡œìŠ¤ìœ¨ ë¯¸ë¦¬ë³´ê¸° (form ë°–)
                        edit_form_kg = st.session_state.get(f"edit_kg_{rid}", 0.0)
                        if kg > 0 and edit_form_kg > 0:
                            loss_kg = kg - edit_form_kg
                            loss_rate = round(loss_kg / kg * 100, 2)
                            if loss_rate >= 0:
                                st.info(f"ğŸ“Š ë¡œìŠ¤ìœ¨: **{loss_rate}%** | ë¡œìŠ¤: **{round(loss_kg, 2)}kg**")
                            else:
                                st.warning(f"âš ï¸ ìƒì‚°ëŸ‰ì´ íˆ¬ì…ëŸ‰ë³´ë‹¤ í½ë‹ˆë‹¤ (ë¡œìŠ¤ìœ¨: {loss_rate}%)")

                        # ìˆ˜ì • ì €ì¥ ì²˜ë¦¬
                        if edit_submitted:
                            try:
                                if edit_product and isinstance(edit_product, str) and " | " in edit_product:
                                    new_p_name = edit_product.split(" | ", 1)[1].strip()
                                elif edit_product:
                                    new_p_name = str(edit_product).strip()
                                else:
                                    new_p_name = ""

                                update_data = {
                                    "product_name": new_p_name,
                                    "production_kg": float(edit_prod_kg),
                                    "memo": edit_memo.strip() if edit_memo else "",
                                    "completed": True if (new_p_name and edit_prod_kg > 0) else False,
                                }
                                update_raw_meat_input(rid, update_data)

                                # ì œí’ˆ-ì›ìœ¡ ë§¤í•‘ ìë™ ë“±ë¡
                                if new_p_name and meat_code:
                                    upsert_product_rawmeat(new_p_name, meat_code, meat_name, origin)

                                st.session_state["_edit_success"] = f"âœ… '{new_p_name}' ìˆ˜ì • ì™„ë£Œ!"
                                st.rerun()
                            except Exception as e:
                                st.error(f"âŒ ìˆ˜ì • ì‹¤íŒ¨: {str(e)}")

                        # í• ë‹¹ í•´ì œ ë²„íŠ¼ (íˆ¬ì… ì›ìœ¡ ë°ì´í„°ëŠ” ìœ ì§€)
                        if st.button("ğŸ”„ í• ë‹¹ í•´ì œ", key=f"edit_reset_{rid}", use_container_width=False):
                            try:
                                update_raw_meat_input(rid, {
                                    "product_name": "",
                                    "production_kg": 0.0,
                                    "memo": "",
                                    "completed": False,
                                })
                                st.session_state["_delete_success"] = "âœ… í• ë‹¹ í•´ì œ ì™„ë£Œ"
                                st.rerun()
                            except Exception as e:
                                st.error(f"âŒ í• ë‹¹ í•´ì œ ì‹¤íŒ¨: {str(e)}")

                st.divider()

    # â”€â”€ ì „ì²´ ìš”ì•½ ë©”íŠ¸ë¦­
    if not df.empty:
        st.markdown("#### ğŸ“Š ì „ì²´ ìš”ì•½")
        total = len(df)
        completed_count = len(assigned) if not assigned.empty else 0
        pending_count = len(unassigned) if not unassigned.empty else 0

        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("ì „ì²´ ê±´ìˆ˜", f"{total}ê±´")
        with col2:
            st.metric("í• ë‹¹ ì™„ë£Œ", f"{completed_count}ê±´")
        with col3:
            st.metric("ë¯¸í• ë‹¹", f"{pending_count}ê±´")
        with col4:
            total_kg = df["kg"].fillna(0).astype(float).sum()
            st.metric("ì´ íˆ¬ì…ëŸ‰", f"{total_kg:,.1f}kg")
