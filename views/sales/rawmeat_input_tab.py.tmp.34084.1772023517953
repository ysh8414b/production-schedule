import streamlit as st
import pandas as pd
from views.sales import (
    load_raw_meat_inputs,
    insert_raw_meat_inputs,
    delete_raw_meat_input,
    cleanup_old_raw_meat_inputs,
    load_loss_assignments,
)


def render_rawmeat_input_tab():
    """íˆ¬ì… ì›ìœ¡ ë°ì´í„° ê´€ë¦¬ íƒ­"""

    # 2ê°œì›” ì´ì „ ë°ì´í„° ìë™ ì‚­ì œ
    cleanup_old_raw_meat_inputs()

    menu = st.radio("ì„ íƒ", [
        "ğŸ“‹ ë°ì´í„° ì¡°íšŒ",
        "ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ",
        "ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ"
    ], horizontal=True, key="rawmeat_input_menu")

    st.divider()

    # ì—…ë¡œë“œ ì„±ê³µ ë©”ì‹œì§€
    if st.session_state.get("_rawmeat_upload_success"):
        st.success(st.session_state["_rawmeat_upload_success"])
        del st.session_state["_rawmeat_upload_success"]

    # ========================
    # ë°ì´í„° ì¡°íšŒ
    # ========================
    if menu == "ğŸ“‹ ë°ì´í„° ì¡°íšŒ":
        st.header("íˆ¬ì… ì›ìœ¡ í˜„í™©")

        df = load_raw_meat_inputs()

        if df.empty:
            st.info("íˆ¬ì…ëœ ì›ìœ¡ì´ ì—†ìŠµë‹ˆë‹¤. 'ì—‘ì…€ ì—…ë¡œë“œ'ì—ì„œ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        else:
            # í• ë‹¹ ìƒíƒœ êµ¬ë¶„
            unassigned = df[
                (df["product_name"].fillna("").astype(str).str.strip() == "") |
                (df["completed"] == False)
            ]
            assigned = df[
                (df["product_name"].fillna("").astype(str).str.strip() != "") &
                (df["completed"] == True)
            ]

            # ë©”íŠ¸ë¦­
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("ì „ì²´ ê±´ìˆ˜", f"{len(df)}ê±´")
            with col2:
                st.metric("ë¯¸í• ë‹¹", f"{len(unassigned)}ê±´")
            with col3:
                st.metric("í• ë‹¹ ì™„ë£Œ", f"{len(assigned)}ê±´")
            with col4:
                total_kg = df["kg"].fillna(0).astype(float).sum()
                st.metric("ì´ íˆ¬ì…ëŸ‰", f"{total_kg:,.1f}kg")

            st.divider()

            # ë‚ ì§œ í•„í„°
            all_dates = sorted(df["move_date"].dropna().unique().tolist(), reverse=True)
            sel_dates = st.multiselect(
                "ğŸ“… ë‚ ì§œ í•„í„°",
                options=all_dates,
                default=[all_dates[0]] if all_dates else [],
                placeholder="ì „ì²´ ë‚ ì§œ",
                key="rawmeat_view_dates"
            )

            filtered = df.copy()
            if sel_dates:
                filtered = filtered[filtered["move_date"].isin(sel_dates)]

            if filtered.empty:
                st.info("í•´ë‹¹ ì¡°ê±´ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                # í• ë‹¹ ìƒíƒœ ì»¬ëŸ¼ ì¶”ê°€
                def _status_label(row):
                    p = str(row.get("product_name", "")).strip()
                    c = row.get("completed", False)
                    if p and c:
                        return "âœ… í• ë‹¹ë¨"
                    return "âš ï¸ ë¯¸í• ë‹¹"

                display_data = []
                for _, row in filtered.iterrows():
                    move_amount = row.get("move_amount", 0)
                    if pd.isna(move_amount):
                        move_amount = 0
                    display_data.append({
                        "ì´ë™ì¼ì": row.get("move_date", ""),
                        "ìƒí’ˆì½”ë“œ": row.get("meat_code", ""),
                        "ìƒí’ˆëª…": row.get("meat_name", ""),
                        "ì›ì‚°ì§€(ë“±ê¸‰)": row.get("origin_grade", ""),
                        "Kg": float(row.get("kg", 0) or 0),
                        "ì´ë™ê¸ˆì•¡": float(move_amount),
                        "ì´ë ¥ë²ˆí˜¸": row.get("tracking_number", ""),
                        "í• ë‹¹ìƒíƒœ": _status_label(row),
                        "í• ë‹¹ì œí’ˆ": str(row.get("product_name", "")).strip(),
                    })

                display_df = pd.DataFrame(display_data)
                st.dataframe(
                    display_df.style.format({
                        "Kg": "{:,.1f}",
                        "ì´ë™ê¸ˆì•¡": "{:,.0f}",
                    }),
                    use_container_width=True, hide_index=True
                )

    # ========================
    # ì—‘ì…€ ì—…ë¡œë“œ
    # ========================
    elif menu == "ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ":
        st.header("íˆ¬ì… ì›ìœ¡ ì—…ë¡œë“œ")
        st.caption("ì—‘ì…€/CSV íŒŒì¼ë¡œ íˆ¬ì…ëœ ì›ìœ¡ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.")
        st.markdown("""
        **ì—…ë¡œë“œ ì–‘ì‹ (ì»¬ëŸ¼ëª…)**
        | ì´ë™ì¼ì | ìƒí’ˆì½”ë“œ | ìƒí’ˆëª… | ì›ì‚°ì§€(ë“±ê¸‰) | Kg | ì´ë™ê¸ˆì•¡ | ì´ë ¥ë²ˆí˜¸ |
        |---------|---------|-------|------------|-----|---------|---------|
        | 2025-01-01 | M001 | ì†Œëª©ì‹¬ | í˜¸ì£¼ì‚°(1ë“±ê¸‰) | 150.5 | 500000 | T20250101-001 |
        """)

        uploaded_file = st.file_uploader(
            "ì—‘ì…€ ë˜ëŠ” CSV íŒŒì¼ ì—…ë¡œë“œ",
            type=["xlsx", "xls", "csv"],
            key="rawmeat_input_upload"
        )

        if uploaded_file:
            try:
                if uploaded_file.name.endswith(".csv"):
                    df_upload = pd.read_csv(uploaded_file)
                else:
                    df_upload = pd.read_excel(uploaded_file)

                # ì»¬ëŸ¼ ë§¤í•‘ (ìœ ì—°í•˜ê²Œ)
                col_map = {}
                for col in df_upload.columns:
                    col_clean = str(col).strip().replace(" ", "")
                    if "ì´ë™ì¼ì" in col_clean or "ì¼ì" in col_clean or "ë‚ ì§œ" in col_clean or "date" in col_clean.lower():
                        col_map[col] = "move_date"
                    elif "ìƒí’ˆì½”ë“œ" in col_clean or "ì›ìœ¡ì½”ë“œ" in col_clean or "ì½”ë“œ" in col_clean or "code" in col_clean.lower():
                        col_map[col] = "meat_code"
                    elif "ìƒí’ˆëª…" in col_clean or "ì›ìœ¡ëª…" in col_clean or "ì›ìœ¡" in col_clean or "ìƒí’ˆ" in col_clean:
                        if "ì½”ë“œ" not in col_clean and "code" not in col_clean.lower():
                            col_map[col] = "meat_name"
                    elif "ì›ì‚°ì§€" in col_clean or "ë“±ê¸‰" in col_clean or "origin" in col_clean.lower():
                        col_map[col] = "origin_grade"
                    elif col_clean.lower() == "kg" or "ë¬´ê²Œ" in col_clean or "ì¤‘ëŸ‰" in col_clean:
                        col_map[col] = "kg"
                    elif "ì´ë™ê¸ˆì•¡" in col_clean or "ê¸ˆì•¡" in col_clean or "amount" in col_clean.lower():
                        col_map[col] = "move_amount"
                    elif "ì´ë ¥ë²ˆí˜¸" in col_clean or "ì´ë ¥" in col_clean or "tracking" in col_clean.lower():
                        col_map[col] = "tracking_number"

                if col_map:
                    df_upload = df_upload.rename(columns=col_map)

                # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
                required = ["move_date", "meat_name", "kg"]
                missing = [c for c in required if c not in df_upload.columns]
                if missing:
                    st.error(f"í•„ìˆ˜ ì»¬ëŸ¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: {', '.join(missing)}")
                    st.info("ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”: ì´ë™ì¼ì, ìƒí’ˆì½”ë“œ, ìƒí’ˆëª…, ì›ì‚°ì§€(ë“±ê¸‰), Kg, ì´ë™ê¸ˆì•¡, ì´ë ¥ë²ˆí˜¸")
                else:
                    # ì„ íƒ ì»¬ëŸ¼ ê¸°ë³¸ê°’
                    for col in ["meat_code", "origin_grade", "tracking_number"]:
                        if col not in df_upload.columns:
                            df_upload[col] = ""
                    if "move_amount" not in df_upload.columns:
                        df_upload["move_amount"] = 0

                    # ë°ì´í„° ì •ë¦¬
                    df_upload["move_date"] = pd.to_datetime(df_upload["move_date"], errors="coerce").dt.strftime("%Y-%m-%d")
                    df_upload["kg"] = pd.to_numeric(df_upload["kg"], errors="coerce").fillna(0)
                    df_upload["move_amount"] = pd.to_numeric(df_upload["move_amount"], errors="coerce").fillna(0)
                    df_upload["meat_code"] = df_upload["meat_code"].fillna("").astype(str).str.strip()
                    df_upload["meat_name"] = df_upload["meat_name"].fillna("").astype(str).str.strip()
                    df_upload["origin_grade"] = df_upload["origin_grade"].fillna("").astype(str).str.strip()
                    df_upload["tracking_number"] = df_upload["tracking_number"].fillna("").astype(str).str.strip()

                    # ìœ íš¨í•œ í–‰ë§Œ
                    valid = df_upload[
                        (df_upload["move_date"].notna()) &
                        (df_upload["meat_name"] != "") &
                        (df_upload["kg"] > 0)
                    ].copy()

                    if valid.empty:
                        st.warning("ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë™ì¼ì, ìƒí’ˆëª…, Kgë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
                    else:
                        st.success(f"ì´ {len(valid)}ê±´ì˜ ìœ íš¨í•œ ë°ì´í„°ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.")

                        # ë¯¸ë¦¬ë³´ê¸°
                        preview = valid[["move_date", "meat_code", "meat_name", "origin_grade", "kg", "move_amount", "tracking_number"]].copy()
                        preview = preview.rename(columns={
                            "move_date": "ì´ë™ì¼ì",
                            "meat_code": "ìƒí’ˆì½”ë“œ",
                            "meat_name": "ìƒí’ˆëª…",
                            "origin_grade": "ì›ì‚°ì§€(ë“±ê¸‰)",
                            "kg": "Kg",
                            "move_amount": "ì´ë™ê¸ˆì•¡",
                            "tracking_number": "ì´ë ¥ë²ˆí˜¸",
                        })
                        st.dataframe(preview, use_container_width=True, hide_index=True)

                        if st.button("ğŸ’¾ ì—…ë¡œë“œ í™•ì •", type="primary", use_container_width=True, key="rawmeat_upload_confirm"):
                            rows = []
                            for _, r in valid.iterrows():
                                rows.append({
                                    "move_date": r["move_date"],
                                    "meat_code": r["meat_code"],
                                    "meat_name": r["meat_name"],
                                    "origin_grade": r["origin_grade"],
                                    "kg": float(r["kg"]),
                                    "move_amount": float(r["move_amount"]),
                                    "tracking_number": r["tracking_number"],
                                    "product_name": "",
                                    "production_kg": 0.0,
                                    "memo": "",
                                    "completed": False,
                                })
                            try:
                                insert_raw_meat_inputs(rows)
                                st.session_state["_rawmeat_upload_success"] = f"âœ… {len(rows)}ê±´ ì—…ë¡œë“œ ì™„ë£Œ!"
                                st.rerun()
                            except Exception as e:
                                st.error(f"âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: {str(e)}")

            except Exception as e:
                st.error(f"âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {str(e)}")

    # ========================
    # ë°ì´í„° ì‚­ì œ
    # ========================
    elif menu == "ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ":
        st.header("íˆ¬ì… ì›ìœ¡ ë°ì´í„° ì‚­ì œ")

        df = load_raw_meat_inputs()

        if df.empty:
            st.info("íˆ¬ì…ëœ ì›ìœ¡ì´ ì—†ìŠµë‹ˆë‹¤.")
        else:
            st.warning("âš ï¸ ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

            # ë‚ ì§œë³„ ì‚­ì œ
            all_dates = sorted(df["move_date"].dropna().unique().tolist(), reverse=True)
            sel_dates = st.multiselect(
                "ì‚­ì œí•  ë‚ ì§œ ì„ íƒ",
                options=all_dates,
                placeholder="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",
                key="rawmeat_del_dates"
            )

            if sel_dates:
                target = df[df["move_date"].isin(sel_dates)]
                st.caption(f"ì‚­ì œ ëŒ€ìƒ: **{len(target)}ê±´**")

                if st.button("ğŸ—‘ï¸ ì‚­ì œ", type="primary", key="rawmeat_del_btn"):
                    st.session_state["confirm_delete_rawmeat"] = True

                if st.session_state.get("confirm_delete_rawmeat"):
                    st.error(f"ì •ë§ë¡œ {len(target)}ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
                    col_a, col_b, _ = st.columns([1, 1, 4])
                    with col_a:
                        if st.button("âœ… ì‚­ì œ í™•ì¸", key="confirm_del_rawmeat"):
                            for _, row in target.iterrows():
                                delete_raw_meat_input(row["id"])
                            st.success("âœ… ì‚­ì œ ì™„ë£Œ!")
                            st.session_state["confirm_delete_rawmeat"] = False
                            st.rerun()
                    with col_b:
                        if st.button("âŒ ì·¨ì†Œ", key="cancel_del_rawmeat"):
                            st.session_state["confirm_delete_rawmeat"] = False
                            st.rerun()
